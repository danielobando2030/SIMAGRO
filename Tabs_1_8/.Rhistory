# Ajusta la elasticidad para que su rango sea igual al de las cantidades y su punto medio sea el promedio de las cantidades
datos_producto$elasticidad_ajustada <- ((datos_producto$elasticidad - min(datos_producto$elasticidad)) / rango_elasticidad) * rango_cantidades + min(datos_producto$cantidad)
# Crea el gráfico base
graf <- plot_ly(datos_producto, x = ~mes, y = ~cantidad, type = "scatter", mode = "lines",
name = "Cantidad", text = ~paste("Cantidades: ", round(cantidad,1)," mil toneladas"), hoverinfo = "text",
line = list(color = "#0D8D38")) %>%
layout(title = "",
xaxis = list(title = "Mes", tickvals = seq(1, 12, 1), ticktext = c("Ene", "Feb", "Mar", "Abr", "May", "Jun", "Jul", "Ago", "Sep", "Oct", "Nov", "Dic"), showgrid = FALSE),
yaxis = list(title = "", showticklabels = FALSE, showgrid = FALSE),
legend = list(orientation = "h", x = 0.5, y = 1.1, xanchor = "center"),
plot_bgcolor = "white",
paper_bgcolor = "white")
# Añade las otras líneas con tooltips personalizadas
graf <- graf %>%
add_trace(y = ~precio_prom / max(datos_producto$precio_prom) * max(datos_producto$cantidad), name = "Precio/Kg", text = ~paste("Precio: $", formatC(precio_prom, format = "f", big.mark = ".", decimal.mark = ",", digits = 0)),
hoverinfo = "text", line = list(color = "#00596C"))
graf <- graf %>%
add_trace(y = ~elasticidad_ajustada, name = "Elasticidad", text = ~paste("Elasticidad:", round(elasticidad,1)), hoverinfo = "text", line = list(color = "#F1B709"), visible = "legendonly")
p<-graf
# Crear el gráfico base
graf <- ggplot(datos_producto, aes(x = mes)) +
geom_line(aes(y = cantidad, color = "Cantidad")) +
theme_minimal() +
scale_color_manual(values = c("#0D8D38", "#00596C")) +
labs(x = "Mes", y = "Miles de toneladas", color = "") +
scale_x_continuous(breaks = seq(1, 12, 1), labels = c("Ene", "Feb", "Mar", "Abr", "May", "Jun", "Jul", "Ago", "Sep", "Oct", "Nov", "Dic")) +
theme(legend.position = "bottom", legend.direction = "horizontal")
# Añadir la segunda línea
graf <- graf + geom_line(aes(y = precio_prom / max(datos_producto$precio_prom) * max(datos_producto$cantidad), color = "Precio/Kg"))
# Añadir el segundo eje y
graf <- graf + scale_y_continuous(sec.axis = sec_axis(~ . * max(datos_producto$precio_prom) / max(datos_producto$cantidad), name = "Precio/Kg"))
graf
datos_producto<-datos_producto%>%select(-elasticidad_ajustada)
nombres_meses <- c("enero", "febrero", "marzo", "abril", "mayo", "junio", "julio", "agosto", "septiembre", "octubre", "noviembre", "diciembre")
nombres_meses2 <- c("Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre")
mes_max <- nombres_meses[datos_producto$mes[which.max(datos_producto$precio_prom)]]
cantidades_max <- round(datos_producto$cantidad[which.max(datos_producto$precio_prom)],1)
precio_max <- formatC(max(datos_producto$precio_prom), format = "f", big.mark = ".", decimal.mark = ",", digits = 0)
producto_sel <- ifelse(alimento == "total", "todos los productos", alimento)
anio_sel <- c(fecha,"todos los años")
mes_max_cant <- nombres_meses2[datos_producto$mes[which.max(datos_producto$cantidad)]]
cant_max<-formatC(max(datos_producto$cantidad), format = "f", big.mark = ".", decimal.mark = ",", digits = 0)
prom_elast<-round(mean(datos_producto$elasticidad,na.rm=TRUE),2)
mensaje2<-paste0(mes_max_cant, " registró el ingreso más alto del periodo, con ", ifelse(cant_max>1,cant_max,""), " mil toneladas.")
mensaje3 <- paste0("En promedio, un cambio del 1% en las cantidades representa",
ifelse(prom_elast < 0, " una disminución de ", " un aumento de "), abs(prom_elast),
"% en el precio. Esto significa que ",
ifelse(abs(prom_elast) > 1, "el precio es muy sensible a los cambios en las cantidades.",
ifelse(abs(prom_elast) < 1, "el precio es menos sensible a los cambios en las cantidades.",
ifelse(abs(prom_elast) == 0, "el precio no cambia con la cantidad demandada.",
"el precio cambia proporcionalmente con la cantidad demandada."))))
return(
list(
grafico=p,
grafico2=graf,
datos =datos_producto,
mes_max =mes_max,
cantidades_max=cantidades_max,
precio_max=precio_max,
mes_max_cant=mes_max_cant,
mensaje2=mensaje2,
mensaje3=mensaje3
#anio_sel=anio_sel
)
)
}
graficar_producto_y_precio(complet, 'total')$grafico
?add_trace
# Define la función
graficar_producto_y_precio <- function(df, alimento, fecha = NULL) {
# Filtra los datos para el producto específico, a menos que alimento sea "total"
if (alimento != "total") {
df <- df %>% filter(producto == alimento)
}
if (!is.null(fecha)){
df <- df %>% filter(anio == fecha)
}
# Calcula la cantidad y el precio promedio por mes
datos_producto <- df %>% filter(ciudad=="Medellín") %>%
mutate(mes = month(mes_y_ano)) %>%
group_by(mes) %>%
summarise(cantidad = sum(suma_kg, na.rm = TRUE)/1000000, precio_prom = mean(precio_prom, na.rm = TRUE),
elasticidad = mean(elasticidad, na.rm = TRUE))
# Calcula el rango de las cantidades
rango_cantidades <- max(datos_producto$cantidad) - min(datos_producto$cantidad)
# Calcula el rango de la elasticidad
rango_elasticidad <- max(datos_producto$elasticidad) - min(datos_producto$elasticidad)
# Calcula el promedio de las cantidades
promedio_cantidades <- mean(datos_producto$cantidad)
# Ajusta la elasticidad para que su rango sea igual al de las cantidades y su punto medio sea el promedio de las cantidades
datos_producto$elasticidad_ajustada <- ((datos_producto$elasticidad - min(datos_producto$elasticidad)) / rango_elasticidad) * rango_cantidades + min(datos_producto$cantidad)
# Crea el gráfico base
graf <- plot_ly(datos_producto, x = ~mes, y = ~cantidad, type = "scatter", mode = "lines",
name = "Cantidad", text = ~paste("Cantidades: ", round(cantidad,1)," mil toneladas"), hoverinfo = "text",
line = list(color = "#0D8D38")) %>%
layout(title = "",
xaxis = list(title = "Mes", tickvals = seq(1, 12, 1), ticktext = c("Ene", "Feb", "Mar", "Abr", "May", "Jun", "Jul", "Ago", "Sep", "Oct", "Nov", "Dic"), showgrid = FALSE),
yaxis = list(title = "", showticklabels = FALSE, showgrid = FALSE),
legend = list(orientation = "h", x = 0.5, y = 1.1, xanchor = "center"),
plot_bgcolor = "white",
paper_bgcolor = "white") %>%
add_trace(y = ~precio_prom / max(datos_producto$precio_prom) * max(datos_producto$cantidad), name = "Precio/Kg", text = ~paste("Precio: $", formatC(precio_prom, format = "f", big.mark = ".", decimal.mark = ",", digits = 0)),
hoverinfo = "text", line = list(color = "#00596C"))
graf <- graf %>%
add_trace(y = ~elasticidad_ajustada, name = "Elasticidad", text = ~paste("Elasticidad:", round(elasticidad,1)), hoverinfo = "text", line = list(color = "#F1B709"), visible = "legendonly")
p<-graf
# Crear el gráfico base
graf <- ggplot(datos_producto, aes(x = mes)) +
geom_line(aes(y = cantidad, color = "Cantidad")) +
theme_minimal() +
scale_color_manual(values = c("#0D8D38", "#00596C")) +
labs(x = "Mes", y = "Miles de toneladas", color = "") +
scale_x_continuous(breaks = seq(1, 12, 1), labels = c("Ene", "Feb", "Mar", "Abr", "May", "Jun", "Jul", "Ago", "Sep", "Oct", "Nov", "Dic")) +
theme(legend.position = "bottom", legend.direction = "horizontal")
# Añadir la segunda línea
graf <- graf + geom_line(aes(y = precio_prom / max(datos_producto$precio_prom) * max(datos_producto$cantidad), color = "Precio/Kg"))
# Añadir el segundo eje y
graf <- graf + scale_y_continuous(sec.axis = sec_axis(~ . * max(datos_producto$precio_prom) / max(datos_producto$cantidad), name = "Precio/Kg"))
graf
datos_producto<-datos_producto%>%select(-elasticidad_ajustada)
nombres_meses <- c("enero", "febrero", "marzo", "abril", "mayo", "junio", "julio", "agosto", "septiembre", "octubre", "noviembre", "diciembre")
nombres_meses2 <- c("Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre")
mes_max <- nombres_meses[datos_producto$mes[which.max(datos_producto$precio_prom)]]
cantidades_max <- round(datos_producto$cantidad[which.max(datos_producto$precio_prom)],1)
precio_max <- formatC(max(datos_producto$precio_prom), format = "f", big.mark = ".", decimal.mark = ",", digits = 0)
producto_sel <- ifelse(alimento == "total", "todos los productos", alimento)
anio_sel <- c(fecha,"todos los años")
mes_max_cant <- nombres_meses2[datos_producto$mes[which.max(datos_producto$cantidad)]]
cant_max<-formatC(max(datos_producto$cantidad), format = "f", big.mark = ".", decimal.mark = ",", digits = 0)
prom_elast<-round(mean(datos_producto$elasticidad,na.rm=TRUE),2)
mensaje2<-paste0(mes_max_cant, " registró el ingreso más alto del periodo, con ", ifelse(cant_max>1,cant_max,""), " mil toneladas.")
mensaje3 <- paste0("En promedio, un cambio del 1% en las cantidades representa",
ifelse(prom_elast < 0, " una disminución de ", " un aumento de "), abs(prom_elast),
"% en el precio. Esto significa que ",
ifelse(abs(prom_elast) > 1, "el precio es muy sensible a los cambios en las cantidades.",
ifelse(abs(prom_elast) < 1, "el precio es menos sensible a los cambios en las cantidades.",
ifelse(abs(prom_elast) == 0, "el precio no cambia con la cantidad demandada.",
"el precio cambia proporcionalmente con la cantidad demandada."))))
return(
list(
grafico=p,
grafico2=graf,
datos =datos_producto,
mes_max =mes_max,
cantidades_max=cantidades_max,
precio_max=precio_max,
mes_max_cant=mes_max_cant,
mensaje2=mensaje2,
mensaje3=mensaje3
#anio_sel=anio_sel
)
)
}
graficar_producto_y_precio(complet, 'total')$grafico
graficar_producto_y_precio(complet, 'total')$grafico
runApp('~/GitHub/Tableros/Pre2')
graficar_producto_y_precio(complet, 'total')$grafico2
# Define la función
graficar_producto_y_precio <- function(df, alimento, fecha = NULL) {
# Filtra los datos para el producto específico, a menos que alimento sea "total"
if (alimento != "total") {
df <- df %>% filter(producto == alimento)
}
if (!is.null(fecha)){
df <- df %>% filter(anio == fecha)
}
# Calcula la cantidad y el precio promedio por mes
datos_producto <- df %>% filter(ciudad=="Medellín") %>%
mutate(mes = month(mes_y_ano)) %>%
group_by(mes) %>%
summarise(cantidad = sum(suma_kg, na.rm = TRUE)/1000000, precio_prom = mean(precio_prom, na.rm = TRUE),
elasticidad = mean(elasticidad, na.rm = TRUE))
# Calcula el rango de las cantidades
rango_cantidades <- max(datos_producto$cantidad) - min(datos_producto$cantidad)
# Calcula el rango de la elasticidad
rango_elasticidad <- max(datos_producto$elasticidad) - min(datos_producto$elasticidad)
# Calcula el promedio de las cantidades
promedio_cantidades <- mean(datos_producto$cantidad)
# Ajusta la elasticidad para que su rango sea igual al de las cantidades y su punto medio sea el promedio de las cantidades
datos_producto$elasticidad_ajustada <- ((datos_producto$elasticidad - min(datos_producto$elasticidad)) / rango_elasticidad) * rango_cantidades + min(datos_producto$cantidad)
# Crea el gráfico base
graf <- plot_ly(datos_producto, x = ~mes, y = ~cantidad, type = "scatter", mode = "lines",
name = "Cantidad", text = ~paste("Cantidades: ", round(cantidad,1)," mil toneladas"), hoverinfo = "text",
line = list(color = "#0D8D38")) %>%
layout(title = "",
xaxis = list(title = "Mes", tickvals = seq(1, 12, 1), ticktext = c("Ene", "Feb", "Mar", "Abr", "May", "Jun", "Jul", "Ago", "Sep", "Oct", "Nov", "Dic"), showgrid = FALSE),
yaxis = list(title = "", showticklabels = FALSE, showgrid = FALSE),
legend = list(orientation = "h", x = 0.5, y = 1.1, xanchor = "center"),
plot_bgcolor = "white",
paper_bgcolor = "white") %>%
add_trace(y = ~precio_prom / max(datos_producto$precio_prom) * max(datos_producto$cantidad), name = "Precio/Kg", text = ~paste("Precio: $", formatC(precio_prom, format = "f", big.mark = ".", decimal.mark = ",", digits = 0)),
hoverinfo = "text", line = list(color = "#00596C"))
graf <- graf %>%
add_trace(y = ~elasticidad_ajustada, name = "Elasticidad", text = ~paste("Elasticidad:", round(elasticidad,1)), hoverinfo = "text", line = list(color = "#F1B709"), visible = "legendonly")
p<-graf
# Crear el gráfico base
graf <- ggplot(datos_producto, aes(x = mes)) +
geom_line(aes(y = cantidad, color = "Cantidad")) +
theme_minimal() +
scale_color_manual(values = c("#0D8D38", "#00596C","#F1B709")) +
labs(x = "Mes", y = "Miles de toneladas", color = "") +
scale_x_continuous(breaks = seq(1, 12, 1), labels = c("Ene", "Feb", "Mar", "Abr", "May", "Jun", "Jul", "Ago", "Sep", "Oct", "Nov", "Dic")) +
theme(legend.position = "bottom", legend.direction = "horizontal")
# Añadir la segunda línea
graf <- graf + geom_line(aes(y = precio_prom / max(datos_producto$precio_prom) * max(datos_producto$cantidad), color = "Precio/Kg"))
graf <- graf + geom_line(aes(y = elasticidad_ajustada / max(datos_producto$elasticidad_ajustada) * max(datos_producto$cantidad), color = "Elasticidad"))+
geom_text(aes(y = elasticidad_ajustada, label = round(elasticidad, 2)), vjust = -0.5, check_overlap = TRUE) + # Añadir etiquetas a la línea de elasticidad
# Añadir el segundo eje y
graf <- graf + scale_y_continuous(sec.axis = sec_axis(~ . * max(datos_producto$precio_prom) / max(datos_producto$cantidad), name = "Precio/Kg"))
graf
datos_producto<-datos_producto%>%select(-elasticidad_ajustada)
nombres_meses <- c("enero", "febrero", "marzo", "abril", "mayo", "junio", "julio", "agosto", "septiembre", "octubre", "noviembre", "diciembre")
nombres_meses2 <- c("Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre")
mes_max <- nombres_meses[datos_producto$mes[which.max(datos_producto$precio_prom)]]
cantidades_max <- round(datos_producto$cantidad[which.max(datos_producto$precio_prom)],1)
precio_max <- formatC(max(datos_producto$precio_prom), format = "f", big.mark = ".", decimal.mark = ",", digits = 0)
producto_sel <- ifelse(alimento == "total", "todos los productos", alimento)
anio_sel <- c(fecha,"todos los años")
mes_max_cant <- nombres_meses2[datos_producto$mes[which.max(datos_producto$cantidad)]]
cant_max<-formatC(max(datos_producto$cantidad), format = "f", big.mark = ".", decimal.mark = ",", digits = 0)
prom_elast<-round(mean(datos_producto$elasticidad,na.rm=TRUE),2)
mensaje2<-paste0(mes_max_cant, " registró el ingreso más alto del periodo, con ", ifelse(cant_max>1,cant_max,""), " mil toneladas.")
mensaje3 <- paste0("En promedio, un cambio del 1% en las cantidades representa",
ifelse(prom_elast < 0, " una disminución de ", " un aumento de "), abs(prom_elast),
"% en el precio. Esto significa que ",
ifelse(abs(prom_elast) > 1, "el precio es muy sensible a los cambios en las cantidades.",
ifelse(abs(prom_elast) < 1, "el precio es menos sensible a los cambios en las cantidades.",
ifelse(abs(prom_elast) == 0, "el precio no cambia con la cantidad demandada.",
"el precio cambia proporcionalmente con la cantidad demandada."))))
return(
list(
grafico=p,
grafico2=graf,
datos =datos_producto,
mes_max =mes_max,
cantidades_max=cantidades_max,
precio_max=precio_max,
mes_max_cant=mes_max_cant,
mensaje2=mensaje2,
mensaje3=mensaje3
#anio_sel=anio_sel
)
)
}
graficar_producto_y_precio(complet, 'total')$grafico2
# Define la función
graficar_producto_y_precio <- function(df, alimento, fecha = NULL) {
# Filtra los datos para el producto específico, a menos que alimento sea "total"
if (alimento != "total") {
df <- df %>% filter(producto == alimento)
}
if (!is.null(fecha)){
df <- df %>% filter(anio == fecha)
}
# Calcula la cantidad y el precio promedio por mes
datos_producto <- df %>% filter(ciudad=="Medellín") %>%
mutate(mes = month(mes_y_ano)) %>%
group_by(mes) %>%
summarise(cantidad = sum(suma_kg, na.rm = TRUE)/1000000, precio_prom = mean(precio_prom, na.rm = TRUE),
elasticidad = mean(elasticidad, na.rm = TRUE))
# Calcula el rango de las cantidades
rango_cantidades <- max(datos_producto$cantidad) - min(datos_producto$cantidad)
# Calcula el rango de la elasticidad
rango_elasticidad <- max(datos_producto$elasticidad) - min(datos_producto$elasticidad)
# Calcula el promedio de las cantidades
promedio_cantidades <- mean(datos_producto$cantidad)
# Ajusta la elasticidad para que su rango sea igual al de las cantidades y su punto medio sea el promedio de las cantidades
datos_producto$elasticidad_ajustada <- ((datos_producto$elasticidad - min(datos_producto$elasticidad)) / rango_elasticidad) * rango_cantidades + min(datos_producto$cantidad)
# Crea el gráfico base
graf <- plot_ly(datos_producto, x = ~mes, y = ~cantidad, type = "scatter", mode = "lines",
name = "Cantidad", text = ~paste("Cantidades: ", round(cantidad,1)," mil toneladas"), hoverinfo = "text",
line = list(color = "#0D8D38")) %>%
layout(title = "",
xaxis = list(title = "Mes", tickvals = seq(1, 12, 1), ticktext = c("Ene", "Feb", "Mar", "Abr", "May", "Jun", "Jul", "Ago", "Sep", "Oct", "Nov", "Dic"), showgrid = FALSE),
yaxis = list(title = "", showticklabels = FALSE, showgrid = FALSE),
legend = list(orientation = "h", x = 0.5, y = 1.1, xanchor = "center"),
plot_bgcolor = "white",
paper_bgcolor = "white") %>%
add_trace(y = ~precio_prom / max(datos_producto$precio_prom) * max(datos_producto$cantidad), name = "Precio/Kg", text = ~paste("Precio: $", formatC(precio_prom, format = "f", big.mark = ".", decimal.mark = ",", digits = 0)),
hoverinfo = "text", line = list(color = "#00596C"))
graf <- graf %>%
add_trace(y = ~elasticidad_ajustada, name = "Elasticidad", text = ~paste("Elasticidad:", round(elasticidad,1)), hoverinfo = "text", line = list(color = "#F1B709"), visible = "legendonly")
p<-graf
# Crear el gráfico base
graf <- ggplot(datos_producto, aes(x = mes)) +
geom_line(aes(y = cantidad, color = "Cantidad")) +
theme_minimal() +
scale_color_manual(values = c("#0D8D38", "#00596C","#F1B709")) +
labs(x = "Mes", y = "Miles de toneladas", color = "") +
scale_x_continuous(breaks = seq(1, 12, 1), labels = c("Ene", "Feb", "Mar", "Abr", "May", "Jun", "Jul", "Ago", "Sep", "Oct", "Nov", "Dic")) +
theme(legend.position = "bottom", legend.direction = "horizontal")
# Añadir la segunda línea
graf <- graf + geom_line(aes(y = precio_prom / max(datos_producto$precio_prom) * max(datos_producto$cantidad), color = "Precio/Kg"))
graf <- graf + geom_line(aes(y = elasticidad_ajustada / max(datos_producto$elasticidad_ajustada) * max(datos_producto$cantidad), color = "Elasticidad"))+
geom_text(aes(y = elasticidad_ajustada, label = round(elasticidad, 2)), vjust = -0.5, check_overlap = TRUE) # Añadir etiquetas a la línea de elasticidad
# Añadir el segundo eje y
graf <- graf + scale_y_continuous(sec.axis = sec_axis(~ . * max(datos_producto$precio_prom) / max(datos_producto$cantidad), name = "Precio/Kg"))
graf
datos_producto<-datos_producto%>%select(-elasticidad_ajustada)
nombres_meses <- c("enero", "febrero", "marzo", "abril", "mayo", "junio", "julio", "agosto", "septiembre", "octubre", "noviembre", "diciembre")
nombres_meses2 <- c("Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre")
mes_max <- nombres_meses[datos_producto$mes[which.max(datos_producto$precio_prom)]]
cantidades_max <- round(datos_producto$cantidad[which.max(datos_producto$precio_prom)],1)
precio_max <- formatC(max(datos_producto$precio_prom), format = "f", big.mark = ".", decimal.mark = ",", digits = 0)
producto_sel <- ifelse(alimento == "total", "todos los productos", alimento)
anio_sel <- c(fecha,"todos los años")
mes_max_cant <- nombres_meses2[datos_producto$mes[which.max(datos_producto$cantidad)]]
cant_max<-formatC(max(datos_producto$cantidad), format = "f", big.mark = ".", decimal.mark = ",", digits = 0)
prom_elast<-round(mean(datos_producto$elasticidad,na.rm=TRUE),2)
mensaje2<-paste0(mes_max_cant, " registró el ingreso más alto del periodo, con ", ifelse(cant_max>1,cant_max,""), " mil toneladas.")
mensaje3 <- paste0("En promedio, un cambio del 1% en las cantidades representa",
ifelse(prom_elast < 0, " una disminución de ", " un aumento de "), abs(prom_elast),
"% en el precio. Esto significa que ",
ifelse(abs(prom_elast) > 1, "el precio es muy sensible a los cambios en las cantidades.",
ifelse(abs(prom_elast) < 1, "el precio es menos sensible a los cambios en las cantidades.",
ifelse(abs(prom_elast) == 0, "el precio no cambia con la cantidad demandada.",
"el precio cambia proporcionalmente con la cantidad demandada."))))
return(
list(
grafico=p,
grafico2=graf,
datos =datos_producto,
mes_max =mes_max,
cantidades_max=cantidades_max,
precio_max=precio_max,
mes_max_cant=mes_max_cant,
mensaje2=mensaje2,
mensaje3=mensaje3
#anio_sel=anio_sel
)
)
}
graficar_producto_y_precio(complet, 'total')$grafico2
# Define la función
graficar_producto_y_precio <- function(df, alimento, fecha = NULL) {
# Filtra los datos para el producto específico, a menos que alimento sea "total"
if (alimento != "total") {
df <- df %>% filter(producto == alimento)
}
if (!is.null(fecha)){
df <- df %>% filter(anio == fecha)
}
# Calcula la cantidad y el precio promedio por mes
datos_producto <- df %>% filter(ciudad=="Medellín") %>%
mutate(mes = month(mes_y_ano)) %>%
group_by(mes) %>%
summarise(cantidad = sum(suma_kg, na.rm = TRUE)/1000000, precio_prom = mean(precio_prom, na.rm = TRUE),
elasticidad = mean(elasticidad, na.rm = TRUE))
# Calcula el rango de las cantidades
rango_cantidades <- max(datos_producto$cantidad) - min(datos_producto$cantidad)
# Calcula el rango de la elasticidad
rango_elasticidad <- max(datos_producto$elasticidad) - min(datos_producto$elasticidad)
# Calcula el promedio de las cantidades
promedio_cantidades <- mean(datos_producto$cantidad)
# Ajusta la elasticidad para que su rango sea igual al de las cantidades y su punto medio sea el promedio de las cantidades
datos_producto$elasticidad_ajustada <- ((datos_producto$elasticidad - min(datos_producto$elasticidad)) / rango_elasticidad) * rango_cantidades + min(datos_producto$cantidad)
# Crea el gráfico base
graf <- plot_ly(datos_producto, x = ~mes, y = ~cantidad, type = "scatter", mode = "lines",
name = "Cantidad", text = ~paste("Cantidades: ", round(cantidad,1)," mil toneladas"), hoverinfo = "text",
line = list(color = "#0D8D38")) %>%
layout(title = "",
xaxis = list(title = "Mes", tickvals = seq(1, 12, 1), ticktext = c("Ene", "Feb", "Mar", "Abr", "May", "Jun", "Jul", "Ago", "Sep", "Oct", "Nov", "Dic"), showgrid = FALSE),
yaxis = list(title = "", showticklabels = FALSE, showgrid = FALSE),
legend = list(orientation = "h", x = 0.5, y = 1.1, xanchor = "center"),
plot_bgcolor = "white",
paper_bgcolor = "white") %>%
add_trace(y = ~precio_prom / max(datos_producto$precio_prom) * max(datos_producto$cantidad), name = "Precio/Kg", text = ~paste("Precio: $", formatC(precio_prom, format = "f", big.mark = ".", decimal.mark = ",", digits = 0)),
hoverinfo = "text", line = list(color = "#00596C"))
graf <- graf %>%
add_trace(y = ~elasticidad_ajustada, name = "Elasticidad", text = ~paste("Elasticidad:", round(elasticidad,1)), hoverinfo = "text", line = list(color = "#F1B709"), visible = "legendonly")
p<-graf
# Crear el gráfico base
graf <- ggplot(datos_producto, aes(x = mes)) +
geom_line(aes(y = cantidad, color = "Cantidad")) +
theme_minimal() +
scale_color_manual(values = c("#0D8D38", "#00596C","#F1B709")) +
labs(x = "Mes", y = "Miles de toneladas", color = "") +
scale_x_continuous(breaks = seq(1, 12, 1), labels = c("Ene", "Feb", "Mar", "Abr", "May", "Jun", "Jul", "Ago", "Sep", "Oct", "Nov", "Dic")) +
theme(legend.position = "bottom", legend.direction = "horizontal")
# Añadir la segunda línea
graf <- graf + geom_line(aes(y = precio_prom / max(datos_producto$precio_prom) * max(datos_producto$cantidad), color = "Precio/Kg"))
graf <- graf + geom_line(aes(y = elasticidad_ajustada, color = "Elasticidad"))+
geom_text(aes(y = elasticidad_ajustada, label = round(elasticidad, 2)), vjust = -0.5, check_overlap = TRUE) # Añadir etiquetas a la línea de elasticidad
# Añadir el segundo eje y
graf <- graf + scale_y_continuous(sec.axis = sec_axis(~ . * max(datos_producto$precio_prom) / max(datos_producto$cantidad), name = "Precio/Kg"))
graf
datos_producto<-datos_producto%>%select(-elasticidad_ajustada)
nombres_meses <- c("enero", "febrero", "marzo", "abril", "mayo", "junio", "julio", "agosto", "septiembre", "octubre", "noviembre", "diciembre")
nombres_meses2 <- c("Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre")
mes_max <- nombres_meses[datos_producto$mes[which.max(datos_producto$precio_prom)]]
cantidades_max <- round(datos_producto$cantidad[which.max(datos_producto$precio_prom)],1)
precio_max <- formatC(max(datos_producto$precio_prom), format = "f", big.mark = ".", decimal.mark = ",", digits = 0)
producto_sel <- ifelse(alimento == "total", "todos los productos", alimento)
anio_sel <- c(fecha,"todos los años")
mes_max_cant <- nombres_meses2[datos_producto$mes[which.max(datos_producto$cantidad)]]
cant_max<-formatC(max(datos_producto$cantidad), format = "f", big.mark = ".", decimal.mark = ",", digits = 0)
prom_elast<-round(mean(datos_producto$elasticidad,na.rm=TRUE),2)
mensaje2<-paste0(mes_max_cant, " registró el ingreso más alto del periodo, con ", ifelse(cant_max>1,cant_max,""), " mil toneladas.")
mensaje3 <- paste0("En promedio, un cambio del 1% en las cantidades representa",
ifelse(prom_elast < 0, " una disminución de ", " un aumento de "), abs(prom_elast),
"% en el precio. Esto significa que ",
ifelse(abs(prom_elast) > 1, "el precio es muy sensible a los cambios en las cantidades.",
ifelse(abs(prom_elast) < 1, "el precio es menos sensible a los cambios en las cantidades.",
ifelse(abs(prom_elast) == 0, "el precio no cambia con la cantidad demandada.",
"el precio cambia proporcionalmente con la cantidad demandada."))))
return(
list(
grafico=p,
grafico2=graf,
datos =datos_producto,
mes_max =mes_max,
cantidades_max=cantidades_max,
precio_max=precio_max,
mes_max_cant=mes_max_cant,
mensaje2=mensaje2,
mensaje3=mensaje3
#anio_sel=anio_sel
)
)
}
graficar_producto_y_precio(complet, 'total')$grafico2
graficar_producto_y_precio(complet, 'total')$grafico
# Define la función
graficar_producto_y_precio <- function(df, alimento, fecha = NULL) {
# Filtra los datos para el producto específico, a menos que alimento sea "total"
if (alimento != "total") {
df <- df %>% filter(producto == alimento)
}
if (!is.null(fecha)){
df <- df %>% filter(anio == fecha)
}
# Calcula la cantidad y el precio promedio por mes
datos_producto <- df %>% filter(ciudad=="Medellín") %>%
mutate(mes = month(mes_y_ano)) %>%
group_by(mes) %>%
summarise(cantidad = sum(suma_kg, na.rm = TRUE)/1000000, precio_prom = mean(precio_prom, na.rm = TRUE),
elasticidad = mean(elasticidad, na.rm = TRUE))
# Calcula el rango de las cantidades
rango_cantidades <- max(datos_producto$cantidad) - min(datos_producto$cantidad)
# Calcula el rango de la elasticidad
rango_elasticidad <- max(datos_producto$elasticidad) - min(datos_producto$elasticidad)
# Calcula el promedio de las cantidades
promedio_cantidades <- mean(datos_producto$cantidad)
# Ajusta la elasticidad para que su rango sea igual al de las cantidades y su punto medio sea el promedio de las cantidades
datos_producto$elasticidad_ajustada <- ((datos_producto$elasticidad - min(datos_producto$elasticidad)) / rango_elasticidad) * rango_cantidades + min(datos_producto$cantidad)
# Crea el gráfico base
graf <- plot_ly(datos_producto, x = ~mes, y = ~cantidad, type = "scatter", mode = "lines",
name = "Cantidad", text = ~paste("Cantidades: ", round(cantidad,1)," mil toneladas"), hoverinfo = "text",
line = list(color = "#0D8D38")) %>%
layout(title = "",
xaxis = list(title = "Mes", tickvals = seq(1, 12, 1), ticktext = c("Ene", "Feb", "Mar", "Abr", "May", "Jun", "Jul", "Ago", "Sep", "Oct", "Nov", "Dic"), showgrid = FALSE),
yaxis = list(title = "", showticklabels = FALSE, showgrid = FALSE),
legend = list(orientation = "h", x = 0.5, y = 1.1, xanchor = "center"),
plot_bgcolor = "white",
paper_bgcolor = "white") %>%
add_trace(y = ~precio_prom / max(datos_producto$precio_prom) * max(datos_producto$cantidad), name = "Precio/Kg", text = ~paste("Precio: $", formatC(precio_prom, format = "f", big.mark = ".", decimal.mark = ",", digits = 0)),
hoverinfo = "text", line = list(color = "#00596C"))
graf <- graf %>%
add_trace(y = ~elasticidad_ajustada, name = "Elasticidad", text = ~paste("Elasticidad:", round(elasticidad,1)), hoverinfo = "text", line = list(color = "#F1B709"), visible = "legendonly")
p<-graf
# Crear el gráfico base
graf <- ggplot(datos_producto, aes(x = mes)) +
geom_line(aes(y = cantidad, color = "Cantidad")) +
theme_minimal() +
scale_color_manual(values = c("#0D8D38","#F1B709", "#00596C")) +
labs(x = "Mes", y = "Miles de toneladas", color = "") +
scale_x_continuous(breaks = seq(1, 12, 1), labels = c("Ene", "Feb", "Mar", "Abr", "May", "Jun", "Jul", "Ago", "Sep", "Oct", "Nov", "Dic")) +
theme(legend.position = "bottom", legend.direction = "horizontal")
# Añadir la segunda línea
graf <- graf + geom_line(aes(y = precio_prom / max(datos_producto$precio_prom) * max(datos_producto$cantidad), color = "Precio/Kg"))
graf <- graf + geom_line(aes(y = elasticidad_ajustada, color = "Elasticidad"))+
geom_text(aes(y = elasticidad_ajustada, label = round(elasticidad, 2)), vjust = -0.5, check_overlap = TRUE) # Añadir etiquetas a la línea de elasticidad
# Añadir el segundo eje y
graf <- graf + scale_y_continuous(sec.axis = sec_axis(~ . * max(datos_producto$precio_prom) / max(datos_producto$cantidad), name = "Precio/Kg"))
graf
datos_producto<-datos_producto%>%select(-elasticidad_ajustada)
nombres_meses <- c("enero", "febrero", "marzo", "abril", "mayo", "junio", "julio", "agosto", "septiembre", "octubre", "noviembre", "diciembre")
nombres_meses2 <- c("Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre")
mes_max <- nombres_meses[datos_producto$mes[which.max(datos_producto$precio_prom)]]
cantidades_max <- round(datos_producto$cantidad[which.max(datos_producto$precio_prom)],1)
precio_max <- formatC(max(datos_producto$precio_prom), format = "f", big.mark = ".", decimal.mark = ",", digits = 0)
producto_sel <- ifelse(alimento == "total", "todos los productos", alimento)
anio_sel <- c(fecha,"todos los años")
mes_max_cant <- nombres_meses2[datos_producto$mes[which.max(datos_producto$cantidad)]]
cant_max<-formatC(max(datos_producto$cantidad), format = "f", big.mark = ".", decimal.mark = ",", digits = 0)
prom_elast<-round(mean(datos_producto$elasticidad,na.rm=TRUE),2)
mensaje2<-paste0(mes_max_cant, " registró el ingreso más alto del periodo, con ", ifelse(cant_max>1,cant_max,""), " mil toneladas.")
mensaje3 <- paste0("En promedio, un cambio del 1% en las cantidades representa",
ifelse(prom_elast < 0, " una disminución de ", " un aumento de "), abs(prom_elast),
"% en el precio. Esto significa que ",
ifelse(abs(prom_elast) > 1, "el precio es muy sensible a los cambios en las cantidades.",
ifelse(abs(prom_elast) < 1, "el precio es menos sensible a los cambios en las cantidades.",
ifelse(abs(prom_elast) == 0, "el precio no cambia con la cantidad demandada.",
"el precio cambia proporcionalmente con la cantidad demandada."))))
return(
list(
grafico=p,
grafico2=graf,
datos =datos_producto,
mes_max =mes_max,
cantidades_max=cantidades_max,
precio_max=precio_max,
mes_max_cant=mes_max_cant,
mensaje2=mensaje2,
mensaje3=mensaje3
#anio_sel=anio_sel
)
)
}
graficar_producto_y_precio(complet, 'total')$grafico2
runApp('~/GitHub/Tableros/Pre2')
runApp('~/GitHub/Tableros/Pre2')
