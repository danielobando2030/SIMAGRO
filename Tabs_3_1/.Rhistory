grafico_interactivo <- tryCatch({
ggplotly(grafico, tooltip = "text") %>%
layout(hoverlabel = list(bgcolor = "white", font = list(size = 12)))
}, error = function(e) {
warning("⚠️ Error al convertir a gráfico interactivo: ", e$message)
return(grafico)
})
# Resultado
list(
grafico   = grafico_interactivo,
datos     = df_graf,
promedio  = mean(df_graf[[variable]], na.rm = TRUE)
)
}
# Mensual
graficar_variable(temporalidad = "mensual", alimento = "aguacate", variable = "precio_prom", anio_filtro = 2023)
# Diario
graficar_variable(temporalidad = "diaria", alimento = "aguacate", variable = "cambio_pct", anio_filtro = 2014)
graficar_variable <- function(temporalidad = c("mensual", "diaria"),
alimento = NULL,
variable = "cambio_pct",
anio_filtro = NULL) {
library(glue)
library(dplyr)
library(ggplot2)
library(plotly)
temporalidad <- match.arg(temporalidad)
df_graf <- if (temporalidad == "mensual") mensual else diaria
# Limpieza y filtrado
df_graf <- df_graf %>%
mutate(across(where(is.character), ~enc2utf8(.))) %>%
mutate(producto = str_to_title(producto)) %>%
filter(!is.na(.data[[variable]]))
if (!is.null(alimento) && alimento != "") {
df_graf <- df_graf %>% filter(producto == str_to_title(alimento))
}
if (!is.null(anio_filtro) && anio_filtro != "") {
df_graf <- df_graf %>% filter(anio == anio_filtro)
}
if (nrow(df_graf) == 0) {
message("⚠️ No hay datos para los filtros seleccionados.")
return(NULL)
}
# Asegurar formato de fecha
df_graf <- df_graf %>%
mutate(mes_y_ano = as.Date(mes_y_ano))
formato_fecha <- if (temporalidad == "mensual") "%b-%Y" else "%d-%b-%Y"
# Crear tooltip manualmente como texto plano (evita el bug de ggplotly)
df_graf <- df_graf %>%
mutate(
tooltip = paste0(
"Fecha: ", format(mes_y_ano, formato_fecha),
"<br>Producto: ", producto,
"<br>", str_to_title(variable), ": ", round(.data[[variable]], 2)
)
)
# Gráfico ggplot
p <- ggplot(df_graf, aes(x = mes_y_ano, y = .data[[variable]], text = tooltip)) +
geom_line(color = "#6A0DAD", linewidth = 1) +
geom_point(color = "#6A0DAD", size = 2) +
scale_x_date(date_labels = "%Y-%m", date_breaks = "2 months") +
labs(x = "Fecha", y = str_to_title(variable)) +
theme_minimal() +
theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1),
plot.title = element_blank())
# Convertir a gráfico interactivo
grafico_interactivo <- plotly::ggplotly(p, tooltip = "text") %>%
layout(
hoverlabel = list(bgcolor = "white", font = list(color = "black")),
hovermode = "x unified"
)
# Retornar todo
list(
grafico   = grafico_interactivo,
datos     = df_graf,
promedio  = mean(df_graf[[variable]], na.rm = TRUE)
)
}
# Mensual
graficar_variable(temporalidad = "mensual", alimento = "aguacate", variable = "precio_prom", anio_filtro = 2023)
# Mensual
graficar_variable(temporalidad = "mensual", alimento = "aguacate", variable = "precio_prom", anio_filtro = 2023)
###### # Author: Luis Miguel GarcC-a
# Laura Quintero
# Daniel Obando
# First Edited: 2025/08/24
# Last Editor: 2025/09/12
# R version: 4.3.2
######
if (interactive())
{ rm(list=ls()) }
###############################
##### Libraries ###############
###############################
pacman::p_load(readr, lubridate, dplyr, ggplot2, zoo, readxl, glue,
tidyverse, gridExtra, corrplot, plotly)
options(scipen = 999)
options(encoding = "UTF-8")
###############################
##### Setting directories #####
###############################
if (Sys.info()[["user"]] == "Usuario") {
print("The user is Usuario")
base_dir <- "C:/Users/Usuario/Universidad EAFIT/VP - 2025_FAO_Cundinamarca"
}
data_input <- file.path(base_dir, "02_AnalisisEmpirico/01_Datos/PreciosMayoristas/Inputs")
data_output <- file.path(base_dir, "02_AnalisisEmpirico/01_Datos/PreciosMayoristas/Outputs")
data_output_index <- file.path(base_dir, "02_AnalisisEmpirico/02_Indices/Outputs")
dist_output_3_1 <- file.path(base_dir, "02_AnalisisEmpirico/03_Dash/3_1")
############################### ##### Load and process mensual #### ###############################
mensual <- readRDS(file.path(dist_output_3_1, "base_mensual_mayoristas_indices_bog_3_1.rds"))
mensual <- mensual %>% mutate(across(where(is.character), ~ enc2utf8(.)))
mensual$anio <- year(mensual$mes_y_ano)
diaria <- readRDS(file.path(dist_output_3_1, "base_diaria_mayoristas_indices_bog_3_1.rds"))
names(diaria)[names(diaria) == "fecha"] <- "mes_y_ano"
diaria <- diaria %>% mutate(across(where(is.character), ~ enc2utf8(.)))
diaria$anio <- year(diaria$mes_y_ano)
##########
graficar_variable <- function(temporalidad = c("mensual", "diaria"),
alimento = NULL,
variable = "cambio_pct",
anio_filtro = NULL) {
library(dplyr)
library(ggplot2)
library(plotly)
library(stringr)
library(glue)
temporalidad <- match.arg(temporalidad)
# Seleccionar dataset según temporalidad
df_graf <- if (temporalidad == "mensual") mensual else diaria
# Asegurar codificación UTF-8 y formato correcto
df_graf <- df_graf %>%
mutate(across(where(is.character), ~ enc2utf8(.))) %>%
mutate(
producto = str_to_title(producto),
mes_y_ano = as.Date(mes_y_ano)
)
# Filtros dinámicos
if (!is.null(alimento) && alimento != "") {
df_graf <- df_graf %>% filter(producto == str_to_title(alimento))
}
if (!is.null(anio_filtro) && anio_filtro != "") {
df_graf <- df_graf %>% filter(anio == anio_filtro)
}
# Verificar que haya datos
if (nrow(df_graf) == 0) {
message("⚠️ No hay datos disponibles para los filtros seleccionados.")
return(NULL)
}
# Crear tooltip seguro
formato_fecha <- if (temporalidad == "mensual") "%b-%Y" else "%d-%b-%Y"
df_graf <- df_graf %>%
mutate(
tooltip = paste0(
"Fecha: ", format(mes_y_ano, formato_fecha),
"<br>Producto: ", producto,
"<br>", str_to_title(variable), ": ", format(round(.data[[variable]], 2), big.mark = ",")
)
)
# Crear gráfico ggplot
p <- ggplot(df_graf, aes(x = mes_y_ano, y = .data[[variable]])) +
geom_line(color = "#6A0DAD", linewidth = 1) +
geom_point(aes(text = tooltip), color = "#6A0DAD", size = 2) +
scale_x_date(date_labels = "%Y-%m", date_breaks = "2 months") +
labs(x = "Fecha", y = str_to_title(variable)) +
theme_minimal() +
theme(
axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1),
plot.title = element_blank()
)
# Convertir a gráfico interactivo sin errores
grafico_interactivo <- suppressWarnings(
ggplotly(p, tooltip = "text") %>%
layout(
hoverlabel = list(bgcolor = "white", font = list(color = "black")),
hovermode = "x unified"
)
)
# Resultado
list(
grafico   = grafico_interactivo,
datos     = df_graf,
promedio  = mean(df_graf[[variable]], na.rm = TRUE)
)
}
# Mensual
graficar_variable(temporalidad = "mensual", alimento = "aguacate", variable = "precio_prom", anio_filtro = 2023)
###### # Author: Luis Miguel GarcC-a
# Laura Quintero
# Daniel Obando
# First Edited: 2025/08/24
# Last Editor: 2025/09/12
# R version: 4.3.2
######
if (interactive())
{ rm(list=ls()) }
###############################
##### Libraries ###############
###############################
pacman::p_load(readr, lubridate, dplyr, ggplot2, zoo, readxl, glue,
tidyverse, gridExtra, corrplot, plotly)
options(scipen = 999)
options(encoding = "UTF-8")
###############################
##### Setting directories #####
###############################
if (Sys.info()[["user"]] == "Usuario") {
print("The user is Usuario")
base_dir <- "C:/Users/Usuario/Universidad EAFIT/VP - 2025_FAO_Cundinamarca"
}
data_input <- file.path(base_dir, "02_AnalisisEmpirico/01_Datos/PreciosMayoristas/Inputs")
data_output <- file.path(base_dir, "02_AnalisisEmpirico/01_Datos/PreciosMayoristas/Outputs")
data_output_index <- file.path(base_dir, "02_AnalisisEmpirico/02_Indices/Outputs")
dist_output_3_1 <- file.path(base_dir, "02_AnalisisEmpirico/03_Dash/3_1")
############################### ##### Load and process mensual #### ###############################
mensual <- readRDS(file.path(dist_output_3_1, "base_mensual_mayoristas_indices_bog_3_1.rds"))
mensual <- mensual %>% mutate(across(where(is.character), ~ enc2utf8(.)))
mensual$anio <- year(mensual$mes_y_ano)
diaria <- readRDS(file.path(dist_output_3_1, "base_diaria_mayoristas_indices_bog_3_1.rds"))
names(diaria)[names(diaria) == "fecha"] <- "mes_y_ano"
diaria <- diaria %>% mutate(across(where(is.character), ~ enc2utf8(.)))
diaria$anio <- year(diaria$mes_y_ano)
##########
graficar_variable <- function(temporalidad = c("mensual", "diaria"),
alimento = NULL,
variable = "cambio_pct",
anio_filtro = NULL) {
library(dplyr)
library(ggplot2)
library(plotly)
library(stringr)
library(glue)
temporalidad <- match.arg(temporalidad)
# Seleccionar dataset según temporalidad
df_graf <- if (temporalidad == "mensual") mensual else diaria
# Asegurar codificación UTF-8 y formato correcto
df_graf <- df_graf %>%
mutate(across(where(is.character), ~ enc2utf8(.))) %>%
mutate(
producto = str_to_title(producto),
mes_y_ano = as.Date(mes_y_ano)
)
# Filtros dinámicos
if (!is.null(alimento) && alimento != "") {
df_graf <- df_graf %>% filter(producto == str_to_title(alimento))
}
if (!is.null(anio_filtro) && anio_filtro != "") {
df_graf <- df_graf %>% filter(anio == anio_filtro)
}
# Verificar que haya datos
if (nrow(df_graf) == 0) {
message("⚠️ No hay datos disponibles para los filtros seleccionados.")
return(NULL)
}
# Crear tooltip seguro
formato_fecha <- if (temporalidad == "mensual") "%b-%Y" else "%d-%b-%Y"
df_graf <- df_graf %>%
mutate(
tooltip = paste0(
"Fecha: ", format(mes_y_ano, formato_fecha),
"<br>Producto: ", producto,
"<br>", str_to_title(variable), ": ", format(round(.data[[variable]], 2), big.mark = ",")
)
)
# Crear gráfico ggplot con text en aes global
p <- ggplot(df_graf, aes(x = mes_y_ano, y = .data[[variable]], text = tooltip)) +
geom_line(color = "#6A0DAD", linewidth = 1) +
geom_point(color = "#6A0DAD", size = 2) +
scale_x_date(date_labels = "%Y-%m", date_breaks = "2 months") +
labs(x = "Fecha", y = str_to_title(variable)) +
theme_minimal() +
theme(
axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1),
plot.title = element_blank()
)
# Convertir a gráfico interactivo
grafico_interactivo <- suppressWarnings(
ggplotly(p, tooltip = "text") %>%
layout(
hoverlabel = list(bgcolor = "white", font = list(color = "black")),
hovermode = "x unified"
)
)
# Resultado
list(
grafico   = grafico_interactivo,
datos     = df_graf,
promedio  = mean(df_graf[[variable]], na.rm = TRUE)
)
}
# Mensual
graficar_variable(temporalidad = "mensual", alimento = "aguacate", variable = "precio_prom", anio_filtro = 2023)
###### # Author: Luis Miguel GarcC-a
# Laura Quintero
# Daniel Obando
# First Edited: 2025/08/24
# Last Editor: 2025/09/12
# R version: 4.3.2
######
if (interactive())
{ rm(list=ls()) }
###############################
##### Libraries ###############
###############################
pacman::p_load(readr, lubridate, dplyr, ggplot2, zoo, readxl, glue,
tidyverse, gridExtra, corrplot, plotly)
options(scipen = 999)
options(encoding = "UTF-8")
###############################
##### Setting directories #####
###############################
if (Sys.info()[["user"]] == "Usuario") {
print("The user is Usuario")
base_dir <- "C:/Users/Usuario/Universidad EAFIT/VP - 2025_FAO_Cundinamarca"
}
data_input <- file.path(base_dir, "02_AnalisisEmpirico/01_Datos/PreciosMayoristas/Inputs")
data_output <- file.path(base_dir, "02_AnalisisEmpirico/01_Datos/PreciosMayoristas/Outputs")
data_output_index <- file.path(base_dir, "02_AnalisisEmpirico/02_Indices/Outputs")
dist_output_3_1 <- file.path(base_dir, "02_AnalisisEmpirico/03_Dash/3_1")
############################### ##### Load and process mensual #### ###############################
mensual <- readRDS(file.path(dist_output_3_1, "base_mensual_mayoristas_indices_bog_3_1.rds"))
mensual <- mensual %>% mutate(across(where(is.character), ~ enc2utf8(.)))
mensual$anio <- year(mensual$mes_y_ano)
diaria <- readRDS(file.path(dist_output_3_1, "base_diaria_mayoristas_indices_bog_3_1.rds"))
names(diaria)[names(diaria) == "fecha"] <- "mes_y_ano"
diaria <- diaria %>% mutate(across(where(is.character), ~ enc2utf8(.)))
diaria$anio <- year(diaria$mes_y_ano)
##########
graficar_variable <- function(temporalidad = c("mensual", "diaria"),
alimento = NULL,
variable = "cambio_pct",
anio_filtro = NULL) {
library(dplyr)
library(ggplot2)
library(plotly)
library(stringr)
temporalidad <- match.arg(temporalidad)
# Selección del dataset
df_graf <- if (temporalidad == "mensual") mensual else diaria
# Estandarizar nombres
df_graf <- df_graf %>%
mutate(across(where(is.character), ~ enc2utf8(.))) %>%
mutate(
producto = str_to_title(producto),
mes_y_ano = as.Date(mes_y_ano)
)
# Aplicar filtros
if (!is.null(alimento) && alimento != "") {
df_graf <- df_graf %>% filter(producto == str_to_title(alimento))
}
if (!is.null(anio_filtro) && anio_filtro != "") {
df_graf <- df_graf %>% filter(anio == anio_filtro)
}
# Verificar datos
if (nrow(df_graf) == 0 || !variable %in% names(df_graf)) {
message("⚠️ No hay datos disponibles para los filtros seleccionados o la variable no existe.")
return(NULL)
}
# Crear tooltip
formato_fecha <- if (temporalidad == "mensual") "%b-%Y" else "%d-%b-%Y"
df_graf <- df_graf %>%
mutate(
tooltip = paste0(
"Fecha: ", format(mes_y_ano, formato_fecha),
"<br>Producto: ", producto,
"<br>", str_to_title(variable), ": ", format(round(.data[[variable]], 2), big.mark = ",")
)
)
# Gráfico base (solo si hay datos válidos)
p <- ggplot(df_graf, aes(x = mes_y_ano, y = .data[[variable]], text = tooltip)) +
geom_line(color = "#6A0DAD", linewidth = 1, na.rm = TRUE) +
geom_point(color = "#6A0DAD", size = 2, na.rm = TRUE) +
labs(x = "Fecha", y = str_to_title(variable)) +
scale_x_date(date_labels = "%Y-%m", date_breaks = "2 months") +
theme_minimal() +
theme(
axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1),
plot.title = element_blank()
)
# ✅ Prevención: verificar que ggplot tiene capas antes de pasar a ggplotly
if (length(p$layers) == 0) {
message("⚠️ El gráfico no tiene capas válidas para convertir a plotly.")
return(NULL)
}
# Conversión a gráfico interactivo (segura)
grafico_interactivo <- tryCatch({
ggplotly(p, tooltip = "text") %>%
layout(
hoverlabel = list(bgcolor = "white", font = list(color = "black")),
hovermode = "x unified"
)
}, error = function(e) {
message("⚠️ Error al convertir a gráfico interactivo: ", e$message)
return(NULL)
})
# Salida final
list(
grafico   = grafico_interactivo,
datos     = df_graf,
promedio  = mean(df_graf[[variable]], na.rm = TRUE)
)
}
# Mensual
graficar_variable(temporalidad = "mensual", alimento = "aguacate", variable = "precio_prom", anio_filtro = 2023)
# Diario
graficar_variable(temporalidad = "diaria", alimento = "aguacate", variable = "cambio_pct", anio_filtro = 2014)
# Mensual
graficar_variable(temporalidad = "mensual", alimento = "aguacate", variable = "precio_prom", anio_filtro = 2023)
# Mensual
graficar_variable(temporalidad = "mensual", alimento = "aguacate", variable = "precio_prom", anio_filtro = 2023)
resultado <- graficar_variable(
temporalidad = "mensual",
alimento = "aguacate",
variable = "precio_prom",
anio_filtro = 2023
)
resultado$grafico
# Mensual
graficar_variable(temporalidad = "mensual", alimento = "aguacate", variable = "precio_prom", anio_filtro = 2023)
# Mensual
graficar_variable(temporalidad = "mensual", alimento = "aguacate", variable = "precio_prom", anio_filtro = 2023)
graficar_variable <- function(temporalidad = c("mensual", "diaria"),
alimento = NULL,
variable = "cambio_pct",
anio_filtro = NULL) {
library(dplyr)
library(ggplot2)
library(plotly)
library(stringr)
temporalidad <- match.arg(temporalidad)
# Selección del dataset
df_graf <- if (temporalidad == "mensual") mensual else diaria
# Estandarizar nombres
df_graf <- df_graf %>%
mutate(across(where(is.character), ~ enc2utf8(.))) %>%
mutate(
producto = str_to_title(producto),
mes_y_ano = as.Date(mes_y_ano)
)
# Aplicar filtros
if (!is.null(alimento) && alimento != "") {
df_graf <- df_graf %>% filter(producto == str_to_title(alimento))
}
if (!is.null(anio_filtro) && anio_filtro != "") {
df_graf <- df_graf %>% filter(anio == anio_filtro)
}
# Verificar datos
if (nrow(df_graf) == 0 || !variable %in% names(df_graf)) {
message("⚠️ No hay datos disponibles para los filtros seleccionados o la variable no existe.")
return(NULL)
}
# Crear tooltip
formato_fecha <- if (temporalidad == "mensual") "%b-%Y" else "%d-%b-%Y"
df_graf <- df_graf %>%
mutate(
tooltip = paste0(
"Fecha: ", format(mes_y_ano, formato_fecha),
"<br>Producto: ", producto,
"<br>", str_to_title(variable), ": ", format(round(.data[[variable]], 2), big.mark = ",")
)
)
# Gráfico base (solo si hay datos válidos)
p <- ggplot(df_graf, aes(x = mes_y_ano, y = .data[[variable]], text = tooltip)) +
geom_line(color = "#6A0DAD", linewidth = 1, na.rm = TRUE) +
geom_point(color = "#6A0DAD", size = 2, na.rm = TRUE) +
labs(x = "Fecha", y = str_to_title(variable)) +
scale_x_date(date_labels = "%Y-%m", date_breaks = "2 months") +
theme_minimal() +
theme(
axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1),
plot.title = element_blank()
)
# ✅ Prevención: verificar que ggplot tiene capas antes de pasar a ggplotly
if (length(p$layers) == 0) {
message("⚠️ El gráfico no tiene capas válidas para convertir a plotly.")
return(NULL)
}
# Conversión a gráfico interactivo (segura)
grafico_interactivo <- tryCatch({
ggplotly(p, tooltip = "text") %>%
layout(
hoverlabel = list(bgcolor = "white", font = list(color = "black")),
hovermode = "x unified"
)
}, error = function(e) {
message("⚠️ Error al convertir a gráfico interactivo: ", e$message)
return(NULL)
})
# Salida final
list(
grafico   = grafico_interactivo,
datos     = df_graf,
promedio  = mean(df_graf[[variable]], na.rm = TRUE)
)
}
# Mensual
graficar_variable(temporalidad = "mensual", alimento = "aguacate", variable = "precio_prom", anio_filtro = 2023)
shiny::runApp()
runApp()
runApp()
runApp('C:/Users/danie/Dropbox/SIMAGRO/Tableros/Tabs_3_2')
runApp('C:/Users/danie/Dropbox/SIMAGRO/Tableros/Tabs_3_3')
runApp('C:/Users/danie/Dropbox/SIMAGRO/Tableros/Tabs_3_3')
shiny::runApp()
runApp('C:/Users/danie/Dropbox/SIMAGRO/Tableros/Tabs_3_2')
runApp('C:/Users/danie/Dropbox/SIMAGRO/Tableros/Tabs_2_7')
runApp('C:/Users/danie/Dropbox/SIMAGRO/Tableros/Tabs_2_7')
runApp('C:/Users/danie/Dropbox/SIMAGRO/Tableros/Tabs_4_2')
runApp('C:/Users/danie/Dropbox/SIMAGRO/Tableros/Tabs_4_2')
runApp('~/GitHub/estatutos-tributarios-shiny')
shiny::runApp()
runApp('C:/Users/danie/Dropbox/SIMAGRO/Tableros/Tabs_3_2')
