geom_treemap_text(
colour = "white",
place = "centre",
reflow = TRUE,
size = 12
) +
scale_fill_gradient(
low = "#f2e6ff",   # púrpura claro
high = "#4b0082",  # púrpura oscuro
name = "tCO₂"
) +
labs(
title = paste("Toneladas de CO₂ emitidas por km recorridos -", mes_nombre, anio_input)
) +
theme_minimal(base_size = 14) +
theme(plot.title = element_text(size = 16, face = "bold"))
}
# Ejemplo:
graficar_treemap_co2(data_merged, anio_input = 2014, mes_input = 12)
######
# Author:       Luis Miguel García
#               Laura Quintero
#               Daniel Obando
# First Edited: 2025/08/24
# Last Editor:  2025/09/12
# R version:    4.3.2
######
###############################
##### Libraries ###############
###############################
rm(list=ls())
pacman::p_load(readr, lubridate, dplyr, ggplot2, zoo, readxl,
glue,  tidyverse, gridExtra, corrplot, plotly,
treemapify)
options(scipen = 999)
###############################
##### Setting directories #####
###############################
if (Sys.info()[["user"]] == "Usuario") {
print("The user is Usuario")
base_dir  <- "C:/Users/Usuario/Universidad EAFIT/VP - 2025_FAO_Cundinamarca"
}
data_input   <- file.path(base_dir,   "02_AnalisisEmpirico/01_Datos/PreciosMayoristas/Inputs")
data_output_pre   <- file.path(base_dir,   "02_AnalisisEmpirico/01_Datos/PreciosMayoristas/Outputs")
data_output_abas  <- file.path(base_dir,   "02_AnalisisEmpirico/01_Datos/Abastecimiento/Outputs")
data_output_index <- file.path(base_dir,   "02_AnalisisEmpirico/02_Indices/Outputs")
### Processing
data <- read_parquet("C:/Users/Usuario/Universidad EAFIT/VP - 2025_FAO_Cundinamarca/02_AnalisisEmpirico/01_Datos/Abastecimiento/Outputs/base_abastecimiento_mensual_no_outliers.parquet")
table(data$grupo_alimento)
names(data)[names(data) == "alimento"] <- "producto"
data$anio <- substr(data$mes_y_ano, 1, 4)
data$mes <- substr(data$mes_y_ano, 6, 7)
#data <- data %>% filter(mpio_destino == "Bogotá") # Filter for exact match
data <- data %>%
group_by(anio, mes, producto) %>%
mutate(
total_kilogramos_año_mes_municipio_producto_bogota = sum(suma_kg[mpio_destino == "Bogotá"], na.rm = TRUE)
) %>%
ungroup()
data$importancia_mpio_origen <- data$suma_kg/data$total_kilogramos_año_mes_municipio_producto_bogota
data$importancia_mpio_origen[data$importancia_mpio_origen == Inf | data$importancia_mpio_origen == -Inf] <- 0
#### Procesando distancias ####
distancias <- read_parquet("C:/Users/Usuario/Universidad EAFIT/VP - 2025_FAO_Cundinamarca/02_AnalisisEmpirico/01_Datos/Distacia/Outputs/Distancias_origen_definitivo.parquet")
distancias_med <- readRDS("C:/Users/Usuario/Universidad EAFIT/VP - 2025_FAO_Cundinamarca/02_AnalisisEmpirico/01_Datos/Distacia/Outputs/rutas_abastecimiendo_medellin.rds")
distancias_LM <- readRDS("C:/Users/Usuario/Universidad EAFIT/VP - 2025_FAO_Cundinamarca/02_AnalisisEmpirico/01_Datos/Distacia/Outputs/distancia.rds")
distancias_long <- distancias_LM %>% pivot_longer(
cols = -origen,
names_to = "destino",
values_to = "distancia") %>% filter(origen != destino)
distancias_long <- distancias_long %>% filter(origen == "11001")
names(distancias_long)[names(distancias_long) == "destino"] <- "codigo_mpio_origen"
dist_path  <- file.path(base_dir, "02_AnalisisEmpirico/01_Datos/Distacia/Inputs")
divipola_geo <- read.csv(file.path(dist_path, "DIVIPOLA-_Códigos_municipios_geolocalizados_20250918.csv"))
divipola_geo <- divipola_geo %>% mutate(
# Remove commas/spaces and ensure character
COD_MPIO = gsub(",", "", COD_MPIO),
COD_MPIO = trimws(as.character(COD_MPIO)),
COD_MPIO = str_pad(COD_MPIO, width = 5, pad = "0"))
divipola_geo <- subset(divipola_geo, select = c(COD_MPIO, LATITUD, LONGITUD))
names(divipola_geo)[names(divipola_geo) == "COD_MPIO"] <- "codigo_mpio_origen"
divipola_geo_bogota <- divipola_geo[divipola_geo$codigo_mpio_origen == "11001", ]
names(divipola_geo_bogota)[names(divipola_geo_bogota) == "LATITUD"] <- "LATITUD_BOG"
names(divipola_geo_bogota)[names(divipola_geo_bogota) == "LONGITUD"] <- "LONGITUD_BOG"
names(divipola_geo_bogota)[names(divipola_geo_bogota) == "codigo_mpio_origen"] <- "codigo_mpio_destino"
### Uniendo distancias y cantidades #####
table(data$grupo_alimento)
names(data)[names(data) == "alimento"] <- "producto"
data$anio <- substr(data$mes_y_ano, 1, 4)
data$mes <- substr(data$mes_y_ano, 6, 7)
data <- data %>% filter(mpio_destino == "Bogotá")
data <- data %>% filter(!(codigo_mpio_origen %in% c("032", "004", ".a.", "n.a.")))
data_merged <- left_join(data, distancias_long, by = c("codigo_mpio_origen")) ## voy acá
data_merged <- left_join(data_merged, divipola_geo, by = c("codigo_mpio_origen")) ## voy acá
data_merged$codigo_mpio_destino <- as.character(data_merged$codigo_mpio_destino)
data_merged <- left_join(data_merged, divipola_geo_bogota, by = c("codigo_mpio_destino")) ## voy acá
#### Datos de emisión
factores_transporte <- tribble(
~producto,                         ~categoria,                          ~factor_gCO2e_kgkm,
# Carnes rojas
"Carne de res",                    "Carnes rojas",                      250,
"Carne de cerdo",                  "Carnes rojas",                      250,
"Carne en pie",                    "Carnes rojas",                      250,
# Carnes blancas y huevos
"Carne de pollo",                  "Carnes blancas y huevos",           180,
"Gallina en pie",                  "Carnes blancas y huevos",           180,
"Pollo en pie",                    "Carnes blancas y huevos",           180,
"Huevo",                           "Carnes blancas y huevos",           180,
"Huevos otros",                    "Carnes blancas y huevos",           180,
# Pescados
"Bagre",                           "Pescados y mariscos frescos",       200,
"Bocachico",                       "Pescados y mariscos frescos",       200,
"Mojarra",                         "Pescados y mariscos frescos",       200,
"Tilapia",                         "Pescados y mariscos frescos",       200,
"Trucha",                          "Pescados y mariscos frescos",       200,
"Mariscos otros",                  "Pescados y mariscos frescos",       200,
"Pescados de mar",                 "Pescados importados refrigerados",  400,
"Basa",                            "Pescados importados refrigerados",  400,
"Pescado seco",                    "Pescados importados refrigerados",  400,
# Lácteos
"Leche cruda",                     "Lácteos y quesos",                  220,
"Leche en polvo",                  "Lácteos y quesos",                  220,
"Lácteos otros",                   "Lácteos y quesos",                  220,
"Quesos y cuajadas",               "Lácteos y quesos",                  220,
# Granos
"Arroz",                           "Granos y cereales secos",           40,
"Maíz Amarillo",                   "Granos y cereales secos",           40,
"Maíz Blanco",                     "Granos y cereales secos",           40,
"Fríjol",                          "Granos y cereales secos",           40,
"Garbanzo",                        "Granos y cereales secos",           40,
"Lenteja",                         "Granos y cereales secos",           40,
"Granos secos",                    "Granos y cereales secos",           40,
# Tubérculos y raíces
"Papa criolla",                    "Tubérculos y raíces",               60,
"Papa capira",                     "Tubérculos y raíces",               60,
"Papa parda pastusa",              "Tubérculos y raíces",               60,
"Papa sabanera",                   "Tubérculos y raíces",               60,
"Yuca",                            "Tubérculos y raíces",               60,
"Arracacha",                       "Tubérculos y raíces",               60,
"Ñame",                            "Tubérculos y raíces",               60,
"Ulluco",                          "Tubérculos y raíces",               60,
# Plátanos y bananos
"Plátano hartón verde",            "Plátanos y bananos",                70,
"Plátano guineo",                  "Plátanos y bananos",                70,
"Plátanos otros",                  "Plátanos y bananos",                70,
"Banano Urabá",                    "Plátanos y bananos",                70,
"Banano criollo",                  "Plátanos y bananos",                70,
"Banano bocadillo",                "Plátanos y bananos",                70,
# Frutas tropicales no refrigeradas
"Papaya",                          "Frutas tropicales no refrigeradas", 60,
"Patilla",                         "Frutas tropicales no refrigeradas", 60,
"Mango común",                     "Frutas tropicales no refrigeradas", 60,
"Guayaba común",                   "Frutas tropicales no refrigeradas", 60,
"Naranja Valencia",                "Frutas tropicales no refrigeradas", 60,
"Limón común",                     "Frutas tropicales no refrigeradas", 60,
# Frutas tropicales refrigeradas
"Aguacate Hass",                   "Frutas tropicales refrigeradas",    120,
"Tomate de árbol",                 "Frutas tropicales refrigeradas",    120,
"Tomate chonto",                   "Frutas tropicales refrigeradas",    120,
"Fresa",                           "Frutas tropicales refrigeradas",    120,
"Uva nacional",                    "Frutas tropicales refrigeradas",    120,
"Lulo",                            "Frutas tropicales refrigeradas",    120,
"Mora",                            "Frutas tropicales refrigeradas",    120,
"Maracuyá",                        "Frutas tropicales refrigeradas",    120,
# Frutas importadas marítimo
"Manzana importada",               "Frutas importadas (marítimo)",      20,
"Uva importada",                   "Frutas importadas (marítimo)",      20,
"Kiwi",                            "Frutas importadas (marítimo)",      20,
"Pera importada",                  "Frutas importadas (marítimo)",      20,
"Durazno importado",               "Frutas importadas (marítimo)",      20,
# Frutas importadas aéreo
"Uva Isabela",                     "Frutas importadas (aéreo)",         800,
"Gulupa exportación",              "Frutas importadas (aéreo)",         800,
"Maracuyá exportación",            "Frutas importadas (aéreo)",         800,
# Hortalizas de hoja
"Lechuga crespa",                  "Hortalizas de hoja y hierbas",      100,
"Lechuga Batavia",                 "Hortalizas de hoja y hierbas",      100,
"Espinaca",                        "Hortalizas de hoja y hierbas",      100,
"Acelga",                          "Hortalizas de hoja y hierbas",      100,
"Cilantro",                        "Hortalizas de hoja y hierbas",      100,
"Perejil",                         "Hortalizas de hoja y hierbas",      100,
"Brócoli",                         "Hortalizas de hoja y hierbas",      100,
"Coliflor",                        "Hortalizas de hoja y hierbas",      100,
"Repollo",                         "Hortalizas de hoja y hierbas",      100,
# Hortalizas de fruto
"Pimentón",                        "Hortalizas de fruto refrigeradas",  120,
"Pepino cohombro",                 "Hortalizas de fruto refrigeradas",  120,
"Calabacín",                       "Hortalizas de fruto refrigeradas",  120,
"Berenjena",                       "Hortalizas de fruto refrigeradas",  120,
"Tomate larga vida",               "Hortalizas de fruto refrigeradas",  120,
# Bulbos
"Cebolla cabezona blanca",         "Hortalizas de bulbo",               80,
"Cebolla junca",                   "Hortalizas de bulbo",               80,
"Ajo",                             "Hortalizas de bulbo",               80,
"Cebolla roja",                    "Hortalizas de bulbo",               80,
# Otros
"Cereales otros",                  "Otros",                             100,
"Verduras y hortalizas otras",     "Otros",                             100,
"Frutas otras",                    "Otros",                             100,
"Tubérculos otros",                "Otros",                             100
)
factores_transporte
factores_transporte <- factores_transporte %>% mutate( factor_tCO2_tkm = factor_gCO2e_kgkm / 1e6)
data_merged <- left_join(data_merged, factores_transporte, by = c("producto")) ## voy acá
data_merged$co2 <- data_merged$factor_tCO2_tkm*data_merged$suma_kg*data_merged$distancia
data_merged <- subset(data_merged, select = c(producto, mes_y_ano, anio, mes , co2, suma_kg, distancia))
######
# Author:       Luis Miguel García
#               Laura Quintero
#               Daniel Obando
# First Edited: 2025/08/24
# Last Editor:  2025/09/12
# R version:    4.3.2
######
###############################
##### Libraries ###############
###############################
rm(list=ls())
pacman::p_load(readr, lubridate, dplyr, ggplot2, zoo, readxl,
glue,  tidyverse, gridExtra, corrplot, plotly,
treemapify)
options(scipen = 999)
###############################
##### Setting directories #####
###############################
if (Sys.info()[["user"]] == "Usuario") {
print("The user is Usuario")
base_dir  <- "C:/Users/Usuario/Universidad EAFIT/VP - 2025_FAO_Cundinamarca"
}
data_input   <- file.path(base_dir,   "02_AnalisisEmpirico/01_Datos/PreciosMayoristas/Inputs")
data_output_pre   <- file.path(base_dir,   "02_AnalisisEmpirico/01_Datos/PreciosMayoristas/Outputs")
data_output_abas  <- file.path(base_dir,   "02_AnalisisEmpirico/01_Datos/Abastecimiento/Outputs")
data_output_index <- file.path(base_dir,   "02_AnalisisEmpirico/02_Indices/Outputs")
### Processing
data <- read_parquet("C:/Users/Usuario/Universidad EAFIT/VP - 2025_FAO_Cundinamarca/02_AnalisisEmpirico/01_Datos/Abastecimiento/Outputs/base_abastecimiento_mensual_no_outliers.parquet")
table(data$grupo_alimento)
names(data)[names(data) == "alimento"] <- "producto"
data$anio <- substr(data$mes_y_ano, 1, 4)
data$mes <- substr(data$mes_y_ano, 6, 7)
#data <- data %>% filter(mpio_destino == "Bogotá") # Filter for exact match
data <- data %>%
group_by(anio, mes, producto) %>%
mutate(
total_kilogramos_año_mes_municipio_producto_bogota = sum(suma_kg[mpio_destino == "Bogotá"], na.rm = TRUE)
) %>%
ungroup()
data$importancia_mpio_origen <- data$suma_kg/data$total_kilogramos_año_mes_municipio_producto_bogota
data$importancia_mpio_origen[data$importancia_mpio_origen == Inf | data$importancia_mpio_origen == -Inf] <- 0
#### Procesando distancias ####
distancias <- read_parquet("C:/Users/Usuario/Universidad EAFIT/VP - 2025_FAO_Cundinamarca/02_AnalisisEmpirico/01_Datos/Distacia/Outputs/Distancias_origen_definitivo.parquet")
distancias_med <- readRDS("C:/Users/Usuario/Universidad EAFIT/VP - 2025_FAO_Cundinamarca/02_AnalisisEmpirico/01_Datos/Distacia/Outputs/rutas_abastecimiendo_medellin.rds")
distancias_LM <- readRDS("C:/Users/Usuario/Universidad EAFIT/VP - 2025_FAO_Cundinamarca/02_AnalisisEmpirico/01_Datos/Distacia/Outputs/distancia.rds")
distancias_long <- distancias_LM %>% pivot_longer(
cols = -origen,
names_to = "destino",
values_to = "distancia") %>% filter(origen != destino)
distancias_long <- distancias_long %>% filter(origen == "11001")
names(distancias_long)[names(distancias_long) == "destino"] <- "codigo_mpio_origen"
dist_path  <- file.path(base_dir, "02_AnalisisEmpirico/01_Datos/Distacia/Inputs")
divipola_geo <- read.csv(file.path(dist_path, "DIVIPOLA-_Códigos_municipios_geolocalizados_20250918.csv"))
divipola_geo <- divipola_geo %>% mutate(
# Remove commas/spaces and ensure character
COD_MPIO = gsub(",", "", COD_MPIO),
COD_MPIO = trimws(as.character(COD_MPIO)),
COD_MPIO = str_pad(COD_MPIO, width = 5, pad = "0"))
divipola_geo <- subset(divipola_geo, select = c(COD_MPIO, LATITUD, LONGITUD))
names(divipola_geo)[names(divipola_geo) == "COD_MPIO"] <- "codigo_mpio_origen"
divipola_geo_bogota <- divipola_geo[divipola_geo$codigo_mpio_origen == "11001", ]
names(divipola_geo_bogota)[names(divipola_geo_bogota) == "LATITUD"] <- "LATITUD_BOG"
names(divipola_geo_bogota)[names(divipola_geo_bogota) == "LONGITUD"] <- "LONGITUD_BOG"
names(divipola_geo_bogota)[names(divipola_geo_bogota) == "codigo_mpio_origen"] <- "codigo_mpio_destino"
### Uniendo distancias y cantidades #####
table(data$grupo_alimento)
names(data)[names(data) == "alimento"] <- "producto"
data$anio <- substr(data$mes_y_ano, 1, 4)
data$mes <- substr(data$mes_y_ano, 6, 7)
data <- data %>% filter(mpio_destino == "Bogotá")
data <- data %>% filter(!(codigo_mpio_origen %in% c("032", "004", ".a.", "n.a.")))
data_merged <- left_join(data, distancias_long, by = c("codigo_mpio_origen")) ## voy acá
data_merged <- left_join(data_merged, divipola_geo, by = c("codigo_mpio_origen")) ## voy acá
data_merged$codigo_mpio_destino <- as.character(data_merged$codigo_mpio_destino)
data_merged <- left_join(data_merged, divipola_geo_bogota, by = c("codigo_mpio_destino")) ## voy acá
#### Datos de emisión
factores_transporte <- tribble(
~producto,                         ~categoria,                          ~factor_gCO2e_kgkm,
# Carnes rojas
"Carne de res",                    "Carnes rojas",                      250,
"Carne de cerdo",                  "Carnes rojas",                      250,
"Carne en pie",                    "Carnes rojas",                      250,
# Carnes blancas y huevos
"Carne de pollo",                  "Carnes blancas y huevos",           180,
"Gallina en pie",                  "Carnes blancas y huevos",           180,
"Pollo en pie",                    "Carnes blancas y huevos",           180,
"Huevo",                           "Carnes blancas y huevos",           180,
"Huevos otros",                    "Carnes blancas y huevos",           180,
# Pescados
"Bagre",                           "Pescados y mariscos frescos",       200,
"Bocachico",                       "Pescados y mariscos frescos",       200,
"Mojarra",                         "Pescados y mariscos frescos",       200,
"Tilapia",                         "Pescados y mariscos frescos",       200,
"Trucha",                          "Pescados y mariscos frescos",       200,
"Mariscos otros",                  "Pescados y mariscos frescos",       200,
"Pescados de mar",                 "Pescados importados refrigerados",  400,
"Basa",                            "Pescados importados refrigerados",  400,
"Pescado seco",                    "Pescados importados refrigerados",  400,
# Lácteos
"Leche cruda",                     "Lácteos y quesos",                  220,
"Leche en polvo",                  "Lácteos y quesos",                  220,
"Lácteos otros",                   "Lácteos y quesos",                  220,
"Quesos y cuajadas",               "Lácteos y quesos",                  220,
# Granos
"Arroz",                           "Granos y cereales secos",           40,
"Maíz Amarillo",                   "Granos y cereales secos",           40,
"Maíz Blanco",                     "Granos y cereales secos",           40,
"Fríjol",                          "Granos y cereales secos",           40,
"Garbanzo",                        "Granos y cereales secos",           40,
"Lenteja",                         "Granos y cereales secos",           40,
"Granos secos",                    "Granos y cereales secos",           40,
# Tubérculos y raíces
"Papa criolla",                    "Tubérculos y raíces",               60,
"Papa capira",                     "Tubérculos y raíces",               60,
"Papa parda pastusa",              "Tubérculos y raíces",               60,
"Papa sabanera",                   "Tubérculos y raíces",               60,
"Yuca",                            "Tubérculos y raíces",               60,
"Arracacha",                       "Tubérculos y raíces",               60,
"Ñame",                            "Tubérculos y raíces",               60,
"Ulluco",                          "Tubérculos y raíces",               60,
# Plátanos y bananos
"Plátano hartón verde",            "Plátanos y bananos",                70,
"Plátano guineo",                  "Plátanos y bananos",                70,
"Plátanos otros",                  "Plátanos y bananos",                70,
"Banano Urabá",                    "Plátanos y bananos",                70,
"Banano criollo",                  "Plátanos y bananos",                70,
"Banano bocadillo",                "Plátanos y bananos",                70,
# Frutas tropicales no refrigeradas
"Papaya",                          "Frutas tropicales no refrigeradas", 60,
"Patilla",                         "Frutas tropicales no refrigeradas", 60,
"Mango común",                     "Frutas tropicales no refrigeradas", 60,
"Guayaba común",                   "Frutas tropicales no refrigeradas", 60,
"Naranja Valencia",                "Frutas tropicales no refrigeradas", 60,
"Limón común",                     "Frutas tropicales no refrigeradas", 60,
# Frutas tropicales refrigeradas
"Aguacate Hass",                   "Frutas tropicales refrigeradas",    120,
"Tomate de árbol",                 "Frutas tropicales refrigeradas",    120,
"Tomate chonto",                   "Frutas tropicales refrigeradas",    120,
"Fresa",                           "Frutas tropicales refrigeradas",    120,
"Uva nacional",                    "Frutas tropicales refrigeradas",    120,
"Lulo",                            "Frutas tropicales refrigeradas",    120,
"Mora",                            "Frutas tropicales refrigeradas",    120,
"Maracuyá",                        "Frutas tropicales refrigeradas",    120,
# Frutas importadas marítimo
"Manzana importada",               "Frutas importadas (marítimo)",      20,
"Uva importada",                   "Frutas importadas (marítimo)",      20,
"Kiwi",                            "Frutas importadas (marítimo)",      20,
"Pera importada",                  "Frutas importadas (marítimo)",      20,
"Durazno importado",               "Frutas importadas (marítimo)",      20,
# Frutas importadas aéreo
"Uva Isabela",                     "Frutas importadas (aéreo)",         800,
"Gulupa exportación",              "Frutas importadas (aéreo)",         800,
"Maracuyá exportación",            "Frutas importadas (aéreo)",         800,
# Hortalizas de hoja
"Lechuga crespa",                  "Hortalizas de hoja y hierbas",      100,
"Lechuga Batavia",                 "Hortalizas de hoja y hierbas",      100,
"Espinaca",                        "Hortalizas de hoja y hierbas",      100,
"Acelga",                          "Hortalizas de hoja y hierbas",      100,
"Cilantro",                        "Hortalizas de hoja y hierbas",      100,
"Perejil",                         "Hortalizas de hoja y hierbas",      100,
"Brócoli",                         "Hortalizas de hoja y hierbas",      100,
"Coliflor",                        "Hortalizas de hoja y hierbas",      100,
"Repollo",                         "Hortalizas de hoja y hierbas",      100,
# Hortalizas de fruto
"Pimentón",                        "Hortalizas de fruto refrigeradas",  120,
"Pepino cohombro",                 "Hortalizas de fruto refrigeradas",  120,
"Calabacín",                       "Hortalizas de fruto refrigeradas",  120,
"Berenjena",                       "Hortalizas de fruto refrigeradas",  120,
"Tomate larga vida",               "Hortalizas de fruto refrigeradas",  120,
# Bulbos
"Cebolla cabezona blanca",         "Hortalizas de bulbo",               80,
"Cebolla junca",                   "Hortalizas de bulbo",               80,
"Ajo",                             "Hortalizas de bulbo",               80,
"Cebolla roja",                    "Hortalizas de bulbo",               80,
# Otros
"Cereales otros",                  "Otros",                             100,
"Verduras y hortalizas otras",     "Otros",                             100,
"Frutas otras",                    "Otros",                             100,
"Tubérculos otros",                "Otros",                             100
)
factores_transporte
factores_transporte <- factores_transporte %>% mutate( factor_tCO2_tkm = factor_gCO2e_kgkm / 1e6)
data_merged <- left_join(data_merged, factores_transporte, by = c("producto")) ## voy acá
data_merged$co2 <- data_merged$factor_tCO2_tkm*data_merged$suma_kg*data_merged$distancia
data_merged <- subset(data_merged, select = c(producto, mes_y_ano, anio, mes , suma_kg, distancia, co2 ,factor_tCO2_tkm))
graficar_treemap_co2 <- function(data, anio_input, mes_input) {
# Convertir a numérico
anio_input <- as.integer(anio_input)
mes_input  <- as.integer(mes_input)
# Extraer nombre del mes en español con format()
mes_nombre <- format(as.Date(paste0("2000-", mes_input, "-01")), "%B")
mes_nombre <- tools::toTitleCase(mes_nombre)  # Capitalizar
data %>%
filter(year(mes_y_ano_date) == anio_input,
month(mes_y_ano_date) == mes_input) %>%
ggplot(aes(area = co2_cens,
fill = co2_cens,
label = producto)) +
geom_treemap() +
geom_treemap_text(
colour = "white",
place = "centre",
reflow = TRUE,
size = 12
) +
scale_fill_gradientn(
colours = c("#f2e6ff", "#d1b3ff", "#a366ff", "#7a1fa2", "#4b0082"),
name = "tCO₂"
) +
labs(
title = paste("Toneladas de CO₂ emitidas por km recorridos -", mes_nombre, anio_input)
) +
theme_minimal(base_size = 14) +
theme(plot.title = element_text(size = 16, face = "bold"))
}
# Ejemplo:
graficar_treemap_co2(data_merged, anio_input = 2014, mes_input = 12)
data_merged <- data_merged %>% mutate(
mes_y_ano_date = as.Date(paste0(mes_y_ano, "-01")))
data_merged <- data_merged %>%
group_by(producto, mes_y_ano_date) %>%
mutate(
p95 = quantile(co2, probs = 0.95, na.rm = TRUE),
co2_cens = ifelse(co2 > p95, p95, co2)
) %>%
ungroup() %>%
select(-p95)  # opcional, para no dejar la columna auxiliar
#### Función
graficar_treemap_co2 <- function(data, anio_input, mes_input) {
# Convertir a numérico
anio_input <- as.integer(anio_input)
mes_input  <- as.integer(mes_input)
# Extraer nombre del mes en español con format()
mes_nombre <- format(as.Date(paste0("2000-", mes_input, "-01")), "%B")
mes_nombre <- tools::toTitleCase(mes_nombre)  # Capitalizar
data %>%
filter(year(mes_y_ano_date) == anio_input,
month(mes_y_ano_date) == mes_input) %>%
ggplot(aes(area = co2_cens,
fill = co2_cens,
label = producto)) +
geom_treemap() +
geom_treemap_text(
colour = "white",
place = "centre",
reflow = TRUE,
size = 12
) +
scale_fill_gradientn(
colours = c("#f2e6ff", "#d1b3ff", "#a366ff", "#7a1fa2", "#4b0082"),
name = "tCO₂"
) +
labs(
title = paste("Toneladas de CO₂ emitidas por km recorridos -", mes_nombre, anio_input)
) +
theme_minimal(base_size = 14) +
theme(plot.title = element_text(size = 16, face = "bold"))
}
# Ejemplo:
graficar_treemap_co2(data_merged, anio_input = 2014, mes_input = 12)
shiny::runApp("C:/Users/Usuario/Universidad EAFIT/VP - 2025_FAO_Cundinamarca/02_AnalisisEmpirico/03_Dash/3_2")
shiny::runApp("C:/Users/Usuario/Universidad EAFIT/VP - 2025_FAO_Cundinamarca/02_AnalisisEmpirico/03_Dash/3_2")
shiny::runApp("C:/Users/Usuario/Universidad EAFIT/VP - 2025_FAO_Cundinamarca/02_AnalisisEmpirico/03_Dash/3_2")
shiny::runApp("C:/Users/Usuario/Universidad EAFIT/VP - 2025_FAO_Cundinamarca/02_AnalisisEmpirico/03_Dash/3_2")
library(sf)
library(dplyr)
# Ruta original
shp_original <- "C:/Users/Usuario/Universidad EAFIT/VP - 2025_FAO_Cundinamarca/02_AnalisisEmpirico/03_Dash/3_2/MGN_ANM_DPTOS.shp"
# Cargar shapefile original
shapefile <- st_read(shp_original)
# 1️⃣ Arreglar geometrías inválidas
shapefile <- st_make_valid(shapefile)
# 2️⃣ Limpiar geometrías problemáticas (bordes duplicados)
# Este paso "repara" geometrías auto-intersectadas
shapefile <- st_buffer(shapefile, 0)
# 3️⃣ Simplificar geometrías para reducir peso (ajusta dTolerance según resultado visual)
shapefile_simple <- st_simplify(shapefile, dTolerance = 2000, preserveTopology = TRUE)
# 4️⃣ Asegurar CRS correcto
shapefile_simple <- st_transform(shapefile_simple, 4326)
# 5️⃣ Eliminar columnas innecesarias
shapefile_simple <- shapefile_simple %>%
select(dpto_ccdgo, nom_depto, geometry)
names(shapefile_simple)
shapefile <- readRDS("shapefile_departamentos_simple.rds")
setwd("C:/Users/Usuario/Universidad EAFIT/VP - 2025_FAO_Cundinamarca/02_AnalisisEmpirico/03_Dash/3_2")
shapefile <- readRDS("shapefile_departamentos_simple.rds")
head(shapefile)
shiny::runApp("C:/Users/Usuario/Universidad EAFIT/VP - 2025_FAO_Cundinamarca/02_AnalisisEmpirico/03_Dash/3_2")
1+1
View(data)
View(shapefile_simple)
View(shapefile)
shiny::runApp("C:/Users/Usuario/Universidad EAFIT/VP - 2025_FAO_Cundinamarca/02_AnalisisEmpirico/03_Dash/3_2")
shiny::runApp("C:/Users/Usuario/Universidad EAFIT/VP - 2025_FAO_Cundinamarca/02_AnalisisEmpirico/03_Dash/3_2")
# Cargar tu shapefile actual
shapefile <- readRDS("shapefile_departamentos_simple.rds")
# Simplificarlo (conservando topología)
# Mantiene ~3% de los vértices originales, puedes ajustar el valor de keep = 0.03
shapefile_ultra <- rmapshaper::ms_simplify(shapefile, keep = 0.03, keep_shapes = TRUE)
# Verificar que la geometría sea válida
shapefile_ultra <- sf::st_make_valid(shapefile_ultra)
# Guardar como RDS
saveRDS(shapefile_ultra, "shapefile_departamentos_ultra.rds")
object.size(shapefile_ultra) / 1024 / 1024
shiny::runApp("C:/Users/Usuario/Universidad EAFIT/VP - 2025_FAO_Cundinamarca/02_AnalisisEmpirico/03_Dash/3_2")
1+1
