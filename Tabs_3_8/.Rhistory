}
calc_cambio_mensual(data, producto = "Aguacate", anio = 2014)
calc_cambio_mensual <- function(data, producto, anio) {
# Establecer idioma de los meses en espa침ol
Sys.setlocale("LC_TIME", "Spanish_Colombia.UTF-8")
if (Sys.getlocale("LC_TIME") == "C") {
Sys.setlocale("LC_TIME", "Spanish")
}
df <- data %>%
mutate(
mes_y_ano = as.Date(paste0(mes_y_ano, "-01")),
anio = year(mes_y_ano)
) %>%
filter(tolower(producto) == tolower(!!producto), anio == !!anio) %>%
arrange(mes_y_ano) %>%
mutate(
cambio_pct_mensual = (precio_prom - lag(precio_prom)) / lag(precio_prom) * 100
) %>%
filter(!is.na(cambio_pct_mensual))
if (nrow(df) == 0) {
warning(paste("No hay datos para", producto, "en", anio))
return(NULL)
}
df <- df %>%
mutate(
text_label = paste0(
"Mes: ", tools::toTitleCase(format(mes_y_ano, "%B %Y")),
"<br>Precio promedio: ", round(precio_prom, 2),
"<br>Cambio % mensual: ", round(cambio_pct_mensual, 2), "%"
)
)
fig <- plot_ly(df,
x = ~mes_y_ano,
y = ~cambio_pct_mensual,
type = 'scatter',
mode = 'lines+markers',
line = list(color = '#9B30FF', width = 2),
marker = list(color = '#9B30FF', size = 8),
text = ~text_label,
hoverinfo = 'text',
showlegend = FALSE) %>%
add_lines(y = 0,
x = ~mes_y_ano,
line = list(color = 'rgba(155,48,255,0.3)', dash = 'dash'),
showlegend = FALSE,
inherit = FALSE,
hoverinfo = "none") %>%
layout(
title = paste("Cambio porcentual mensual del precio promedio -", producto, anio),
xaxis = list(
title = "Mes",
tickvals = df$mes_y_ano,
ticktext = tools::toTitleCase(format(df$mes_y_ano, "%b")),  # 游녣 Ene, Feb, Mar...
tickangle = -45,
tickfont = list(size = 12)
),
yaxis = list(title = "Cambio % mensual"),
hovermode = "x unified"
)
return(fig)
}
calc_cambio_mensual(data, producto = "Aguacate", anio = 2014)
calc_cambio_mensual <- function(data, producto, anio) {
# Establecer idioma de los meses en espa침ol
Sys.setlocale("LC_TIME", "Spanish_Colombia.UTF-8")
if (Sys.getlocale("LC_TIME") == "C") {
Sys.setlocale("LC_TIME", "Spanish")
}
df <- data %>%
mutate(
mes_y_ano = as.Date(paste0(mes_y_ano, "-01")),
anio = year(mes_y_ano)
) %>%
filter(tolower(producto) == tolower(!!producto), anio == !!anio) %>%
arrange(mes_y_ano) %>%
mutate(
cambio_pct_mensual = (precio_prom - lag(precio_prom)) / lag(precio_prom) * 100
) %>%
filter(!is.na(cambio_pct_mensual))
if (nrow(df) == 0) {
warning(paste("No hay datos para", producto, "en", anio))
return(NULL)
}
df <- df %>%
mutate(
text_label = paste0(
"Mes: ", tools::toTitleCase(format(mes_y_ano, "%B %Y")),
"<br>Precio promedio: ", round(precio_prom, 2),
"<br>Cambio % mensual: ", round(cambio_pct_mensual, 2), "%"
)
)
fig <- plot_ly(df,
x = ~mes_y_ano,
y = ~cambio_pct_mensual,
type = 'scatter',
mode = 'lines+markers',
line = list(color = '#9B30FF', width = 2),
marker = list(color = '#9B30FF', size = 8),
text = ~text_label,
hoverinfo = 'text',
showlegend = FALSE) %>%
add_lines(y = 0,
x = ~mes_y_ano,
line = list(color = 'rgba(155,48,255,0.3)', dash = 'dash'),
showlegend = FALSE,
inherit = FALSE,
hoverinfo = "none") %>%
layout(
title = list(text = ""),  # 游녣 sin t칤tulo
xaxis = list(
title = "Mes",
tickvals = df$mes_y_ano,
ticktext = tools::toTitleCase(format(df$mes_y_ano, "%b")),
tickangle = -45,
tickfont = list(size = 12)
),
yaxis = list(title = "Cambio % mensual"),
hovermode = "x unified"
)
return(fig)
}
calc_cambio_mensual(data, producto = "Aguacate", anio = 2014)
setwd("C:/Users/Usuario/Universidad EAFIT/VP - 2025_FAO_Cundinamarca/02_AnalisisEmpirico/03_Dash/3_7")
shiny::runApp()
setwd("C:/Users/Usuario/Universidad EAFIT/VP - 2025_FAO_Cundinamarca/02_AnalisisEmpirico/03_Dash/3_7")
shiny::runApp()
setwd("C:/Users/Usuario/Universidad EAFIT/VP - 2025_FAO_Cundinamarca/02_AnalisisEmpirico/03_Dash/3_7")
shiny::runApp()
######
# Author:       Luis Miguel GarcC-a
#               Laura Quintero
#               Daniel Obando
# First Edited: 2025/08/24
# Last Editor:  2025/09/12
# R version:    4.3.2
######
################################################################################-
# Limpiar el entorno de trabajo
rm(list=ls())
# Paquetes
################################################################################-
pacman::p_load(readr, lubridate, dplyr, ggplot2, zoo, readxl,
glue,  tidyverse, gridExtra, corrplot, arrow)
options(scipen = 999)
###############################
###############################
##### Setting directories #####
###############################
if (Sys.info()[["user"]] == "Usuario") {
print("The user is Usuario")
base_dir  <- "C:/Users/Usuario/Universidad EAFIT/VP - 2025_FAO_Cundinamarca"
}
data_input   <- file.path(base_dir,   "02_AnalisisEmpirico/01_Datos/PreciosMayoristas/Inputs")
data_output_pre   <- file.path(base_dir, "02_AnalisisEmpirico/01_Datos/PreciosMayoristas/Outputs")
data_output_abas  <- file.path(base_dir, "02_AnalisisEmpirico/01_Datos/Abastecimiento/Outputs")
data_output_index <- file.path(base_dir, "02_AnalisisEmpirico/02_Indices/Outputs")
data_dist_output  <- file.path(base_dir, "02_AnalisisEmpirico/01_Datos/Distacia/Outputs")
dist_output_3_8 <- file.path(base_dir, "02_AnalisisEmpirico/03_Dash/3_8")
#############################
## Procesamiento base mensual
data <- readRDS(file.path(data_output_pre, "base_precios_mayorista_mes_filtrados.rds"))
data <-data%>%
mutate(mes_y_ano = floor_date(as.Date(as.yearmon(mes_y_ano, "%Y-%m"), frac = 1), "month"))%>%
mutate(anio = year(mes_y_ano))
data <- data %>%
mutate(mes_y_ano = as.Date(paste0(mes_y_ano, "-01"))) %>%
group_by(ciudad, producto) %>%
complete(mes_y_ano = seq.Date(min(mes_y_ano), max(mes_y_ano), by = "month")) %>%
ungroup() %>%
arrange(ciudad, producto, mes_y_ano)
data <- data %>%
arrange(ciudad, producto, mes_y_ano) %>%
group_by(ciudad, producto) %>%
mutate(cambio_pct = (precio_prom / lag(precio_prom) - 1) * 100)
data <- data %>%
mutate(mes_y_ano = floor_date(as.Date(as.yearmon(mes_y_ano, "%Y-%m"), frac = 1), "month")) %>%
drop_na(mes_y_ano) %>%
ungroup() %>%
complete(ciudad, producto, mes_y_ano = seq.Date(min(mes_y_ano, na.rm = TRUE), max(mes_y_ano, na.rm = TRUE), by = "month")) %>%
group_by(ciudad, producto)
data <- data %>%
arrange(ciudad, producto, mes_y_ano) %>%
group_by(ciudad, producto) %>%
mutate(cambio_pct_anual = (precio_prom / lag(precio_prom, 12) - 1) * 100) %>%
ungroup() %>%
mutate(producto = str_to_lower(producto))
data$anio <- year(data$mes_y_ano)
data <- filter(data, ciudad == "BogotC\u00e1")
saveRDS(data, file.path(data_output_index, "precios_bogota_balanceado_3_8.rds"))
data <- readRDS(file.path(data_output_pre, "base_precios_mayorista_mes_filtrados.rds"))
data <-data%>%
mutate(mes_y_ano = floor_date(as.Date(as.yearmon(mes_y_ano, "%Y-%m"), frac = 1), "month"))%>%
mutate(anio = year(mes_y_ano))
##########################
##### Precios balanceado
data <- data %>%
mutate(mes_y_ano = as.Date(paste0(mes_y_ano, "-01"))) %>%
group_by(ciudad, producto) %>%
complete(mes_y_ano = seq.Date(min(mes_y_ano), max(mes_y_ano), by = "month")) %>%
ungroup() %>%
arrange(ciudad, producto, mes_y_ano)
data <- data %>%
arrange(ciudad, producto, mes_y_ano) %>%
group_by(ciudad, producto) %>%
mutate(cambio_pct = (precio_prom / lag(precio_prom) - 1) * 100)
data <- data %>%
mutate(mes_y_ano = floor_date(as.Date(as.yearmon(mes_y_ano, "%Y-%m"), frac = 1), "month")) %>%
drop_na(mes_y_ano) %>%
ungroup() %>%
complete(ciudad, producto, mes_y_ano = seq.Date(min(mes_y_ano, na.rm = TRUE), max(mes_y_ano, na.rm = TRUE), by = "month")) %>%
group_by(ciudad, producto)
data <- data %>%
arrange(ciudad, producto, mes_y_ano) %>%
group_by(ciudad, producto) %>%
mutate(cambio_pct_anual = (precio_prom / lag(precio_prom, 12) - 1) * 100) %>%
ungroup() %>%
mutate(producto = str_to_lower(producto))
data$anio <- year(data$mes_y_ano)
data <- filter(data, ciudad == "Bogot치")
table(data$mes_y_ano)
View(data)
saveRDS(data, file.path(data_output_index, "precios_bogota_balanceado_3_8.rds"))
saveRDS(data, file.path(dist_output_3_8, "precios_bogota_balanceado_3_8.rds"))
data_output_index_3_8 <- file.path(base_dir,   "02_AnalisisEmpirico/03_Dash/3_8")
######
# Author:       Luis Miguel Garc칤a
#               Laura Quintero
#               Daniel Obando
# First Edited: 2025/08/24
# Last Editor:  2025/09/12
# R version:    4.3.2
######
if (interactive()) {
rm(list=ls())
}
###############################
##### Libraries ###############
###############################
pacman::p_load(readr, lubridate, dplyr, ggplot2, zoo, readxl,
glue,  tidyverse, gridExtra, corrplot)
options(scipen = 999)
###############################
##### Setting directories #####
###############################
if (Sys.info()[["user"]] == "Usuario") {
print("The user is Usuario")
base_dir  <- "C:/Users/Usuario/Universidad EAFIT/VP - 2025_FAO_Cundinamarca"
}
data_input   <- file.path(base_dir,   "02_AnalisisEmpirico/01_Datos/PreciosMayoristas/Inputs")
data_output  <- file.path(base_dir,   "02_AnalisisEmpirico/01_Datos/PreciosMayoristas/Outputs")
data_output_index <- file.path(base_dir,   "02_AnalisisEmpirico/02_Indices/Outputs")
data_output_index_3_8 <- file.path(base_dir,   "02_AnalisisEmpirico/03_Dash/3_8")
###############################
##### Load and process data ###
###############################
data <- readRDS(file.path(data_output_index_3_8, "precios_bogota_balanceado_3_8.rds"))
## LLenar con el promedio del valor anterior y el que sigue
data <- data %>%
arrange(producto, mes_y_ano) %>%              # asegurar el orden
group_by(producto) %>%                        # hacer por cada producto
mutate(precio_prom = na.approx(precio_prom, na.rm = FALSE)) %>%
ungroup()
## Contar si hay missings por productos
missings <- data %>% group_by(producto) %>% summarise(n_missing = sum(is.na(precio_prom)))
fill_ma_both <- function(x, k = 12) {
n <- length(x)
# Hacia atr치s (para NAs iniciales)
for (i in seq(n, 1)) {
if (is.na(x[i])) {
future_vals <- x[(i+1):min(n, i+k)]
future_vals <- future_vals[!is.na(future_vals)]
if (length(future_vals) > 0) {
x[i] <- mean(future_vals)
}
}
}
# Hacia adelante (para NAs finales)
for (i in seq_len(n)) {
if (is.na(x[i])) {
past_vals <- x[max(1, i-k):(i-1)]
past_vals <- past_vals[!is.na(past_vals)]
if (length(past_vals) > 0) {
x[i] <- mean(past_vals)
}
}
}
return(x)
}
# Aplicar por producto
data <- data %>%
arrange(producto, mes_y_ano) %>%
group_by(producto) %>%
mutate(precio_prom = fill_ma_both(precio_prom, k = 12)) %>%
ungroup()
## Contar si hay missings por productos
missings <- data %>% group_by(producto) %>% summarise(n_missing = sum(is.na(precio_prom)))
#### Termino de limpiar la base
data <- data  %>% select(ciudad, producto, mes_y_ano, precio_prom)
data$anio <- year(data$mes_y_ano)
data$mes <- month(data$mes_y_ano)
##### Funcion de correlaci칩n
correlacion_precios <- function(data, anio){
# Filtrar por a침o (usando la columna num칠rica `anio`)
df <- data %>%
filter(anio == !!anio) %>%
select(producto, mes_y_ano, precio_prom) %>%
distinct()
# Pasar a formato ancho: cada producto en una columna
df_wide <- df %>%
pivot_wider(names_from = producto, values_from = precio_prom)
# Quitar columna de fechas para calcular correlaci칩n
df_mat <- df_wide %>% select(-mes_y_ano)
# Calcular matriz de correlaciones
cor_mat <- cor(df_mat, use = "pairwise.complete.obs")
# Convertir a formato largo para graficar
cor_df <- as.data.frame(as.table(cor_mat))
colnames(cor_df) <- c("Producto1", "Producto2", "Correlacion")
cor_df$Correlacion <- round(cor_df$Correlacion, 2) # redondear a 2 d칤gitos
# Graficar con ggplot2
p <- ggplot(cor_df, aes(x = Producto1, y = Producto2, fill = Correlacion)) +
geom_tile(color = "white") +
geom_text(aes(label = Correlacion), color = "black", size = 3) +
scale_fill_gradient2(low = "#8e44ad", mid = "white", high = "#e74c3c",
midpoint = 0, limit = c(-1,1), name = "Correlaci칩n") +
labs(title = paste("Matriz de correlaci칩n de precios de productos -", anio)) +
theme_minimal() +
theme(axis.text.x = element_text(angle = 45, hjust = 1),
axis.title = element_blank())
return(list(
matriz = cor_mat,
grafico = p
))
}
matriz_precios_2018 <- correlacion_precios(data, 2018)
matriz_precios_2023 <- correlacion_precios(data, 2023)
matriz_precios_2023$grafico
matriz_precios_2018$grafico
correlacion_precios_interactivo <- function(data, anio) {
df <- data %>%
filter(anio == !!anio) %>%
select(producto, mes_y_ano, precio_prom) %>%
distinct()
df_wide <- df %>%
pivot_wider(names_from = producto, values_from = precio_prom)
df_mat <- df_wide %>% select(-mes_y_ano)
cor_mat <- cor(df_mat, use = "pairwise.complete.obs")
cor_df <- as.data.frame(as.table(cor_mat))
colnames(cor_df) <- c("Producto1", "Producto2", "Correlacion")
cor_df <- cor_df %>% mutate(texto = paste0(
"<b>", Producto1, "</b> vs <b>", Producto2, "</b><br>",
"Correlaci칩n: ", round(Correlacion, 2)
))
plot_ly(
data = cor_df,
x = ~Producto1,
y = ~Producto2,
z = ~Correlacion,
type = "heatmap",
colorscale = list(
list(0, "#8e44ad"),  # p칰rpura
list(0.5, "white"),
list(1, "#e74c3c")   # rojo
),
text = ~texto,
hoverinfo = "text",
colorbar = list(title = "Correlaci칩n", tickformat = ".2f")
) %>%
layout(
title = paste("Matriz de correlaciones -", anio),
xaxis = list(title = ""),
yaxis = list(title = ""),
margin = list(l = 80, b = 100, t = 60, r = 40)
)
}
matriz_precios_2023 <- correlacion_precios_interactivo(data, 2023)
matriz_precios_2023$grafico
correlacion_precios_interactivo(data, 2023)
correlacion_precios <- function(data, anio){
# Filtrar por a침o
df <- data %>%
filter(anio == !!anio) %>%
select(producto, mes_y_ano, precio_prom) %>%
distinct()
# Pasar a formato ancho
df_wide <- df %>%
pivot_wider(names_from = producto, values_from = precio_prom)
# Quitar columna de fechas
df_mat <- df_wide %>% select(-mes_y_ano)
# Calcular matriz de correlaciones
cor_mat <- cor(df_mat, use = "pairwise.complete.obs")
# Convertir a formato largo
cor_df <- as.data.frame(as.table(cor_mat))
colnames(cor_df) <- c("Producto1", "Producto2", "Correlacion")
cor_df$Correlacion <- round(cor_df$Correlacion, 2)
# Convertir a may칰scula inicial
cor_df <- cor_df %>%
mutate(
Producto1 = str_to_title(Producto1),
Producto2 = str_to_title(Producto2)
)
# Graficar
p <- ggplot(cor_df, aes(x = Producto1, y = Producto2, fill = Correlacion)) +
geom_tile(color = "white") +
geom_text(aes(label = Correlacion), color = "black", size = 3) +
scale_fill_gradient2(
low = "#8e44ad", mid = "white", high = "#e74c3c",
midpoint = 0, limit = c(-1, 1), name = "Correlaci칩n"
) +
labs(title = paste("Matriz de correlaci칩n de precios de productos -", anio)) +
theme_minimal() +
theme(
axis.text.x = element_text(angle = 45, hjust = 1),
axis.title = element_blank()
)
return(list(
matriz = cor_mat,
grafico = p
))
}
correlacion_precios(data, 2023)
correlacion_precios <- function(data, anio){
# Filtrar por a침o
df <- data %>%
filter(anio == !!anio) %>%
select(producto, mes_y_ano, precio_prom) %>%
distinct()
# Pasar a formato ancho
df_wide <- df %>%
pivot_wider(names_from = producto, values_from = precio_prom)
# Quitar columna de fechas
df_mat <- df_wide %>% select(-mes_y_ano)
# Calcular matriz de correlaciones
cor_mat <- cor(df_mat, use = "pairwise.complete.obs")
# Nombres con may칰scula inicial
productos <- str_to_title(colnames(cor_mat))
colnames(cor_mat) <- productos
rownames(cor_mat) <- productos
# Crear gr치fico interactivo con Plotly
fig <- plot_ly(
z = cor_mat,
x = productos,
y = productos,
type = "heatmap",
colorscale = list(
list(0, "#8e44ad"),
list(0.5, "white"),
list(1, "#e74c3c")
),
zmin = -1, zmax = 1,
hovertemplate = paste(
"<b>%{x}</b> vs <b>%{y}</b><br>",
"Correlaci칩n: %{z:.2f}<extra></extra>"
)
) %>%
layout(
title = list(text = paste("Matriz de correlaci칩n de precios de productos -", anio),
x = 0.5, font = list(size = 16)),
xaxis = list(title = "", tickangle = 45),
yaxis = list(title = "", autorange = "reversed")
)
return(list(
matriz = cor_mat,
grafico = fig
))
}
correlacion_precios(data, 2023)
shiny::runApp()
setwd("C:/Users/Usuario/Universidad EAFIT/VP - 2025_FAO_Cundinamarca/02_AnalisisEmpirico/03_Dash/3_8")
shiny::runApp()
shiny::runApp()
shiny::runApp()
runApp('C:/Users/danie/Dropbox/SIMAGRO/Tableros/Tabs_4_1')
runApp('C:/Users/danie/Dropbox/SIMAGRO/Tableros/Tabs_4_1')
grafico_interactivo <- plot_ly(
data = df_graf,
x = ~mes_y_ano,
y = as.formula(paste0("~", variable)),
type = "scatter",
mode = "lines+markers",
text = ~etiqueta,
hoverinfo = "text",
line = list(color = "#6A0DAD", width = 2),
marker = list(color = "#6A0DAD", size = 6)
) %>%
layout(
xaxis = list(title = "Fecha"),
yaxis = list(title = str_to_title(variable)),
hoverlabel = list(bgcolor = "white", font = list(color = "black")),
hovermode = "x unified"
)
###### # Author: Luis Miguel GarcC-a
# Laura Quintero
# Daniel Obando
# First Edited: 2025/08/24
# Last Editor: 2025/09/12
# R version: 4.3.2
######
if (interactive())
{ rm(list=ls()) }
###############################
##### Libraries ###############
###############################
pacman::p_load(readr, lubridate, dplyr, ggplot2, zoo, readxl, glue,
tidyverse, gridExtra, corrplot, plotly, shiny)
options(scipen = 999)
options(encoding = "UTF-8")
###############################
##### Setting directories #####
###############################
############################### ##### Load and process mensual #### ###############################
mensual <- readRDS("base_mensual_mayoristas_indices_bog_3_1.rds")
runApp('C:/Users/danie/Dropbox/SIMAGRO/Tableros/Tabs_3_1')
