---
title: " "
params:
  datos: NA
  grafico: NA
  temporalidad: NA
  variable: NA
  anio: NA
  producto: NA
  promedio: NA
  fecha_max: NA
  fecha_min: NA
  prod_mas_volatil: NA
  promedio_cambio: NA
  mes_max: NA
  valor_max: NA
output:
  pdf_document:
    latex_engine: xelatex
    toc: false
header-includes:
- \usepackage{float}
- \usepackage{booktabs}
- \usepackage{xcolor}
- \usepackage{fontspec}
- \usepackage{fancyhdr}
- \usepackage{graphicx}
- \usepackage{colortbl}
- \usepackage{adjustbox}
- \usepackage{longtable}
- \usepackage{multirow}
- \usepackage{caption}
- \definecolor{violetaFAO}{RGB}{123,31,162}
- \definecolor{grisFAO}{RGB}{80,80,80}
- \definecolor{verdeFAO}{RGB}{26,150,65}
- \definecolor{rojoFAO}{RGB}{215,25,28}
- \setmainfont{Prompt-Regular.ttf}
- \pagestyle{fancy}
- \fancyhead{}
- \fancyfoot{}
- \setlength{\headheight}{2cm}
- \fancyhead[C]{\includegraphics[width=\textwidth]{www/logo_3.png}}
- \renewcommand{\headrule}{\color{violetaFAO}\hrule width\headwidth height\headrulewidth}
- \usepackage{eso-pic}
---

```{r setup, include=FALSE, message=FALSE, warning=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
library(knitr)
library(kableExtra)
library(dplyr)
library(stringr)
library(htmlwidgets)
library(webshot2)
library(plotly)
try(Sys.setlocale("LC_TIME", "es_ES.UTF-8"), silent = TRUE)
df <- params$datos
```

\begin{flushright}
\textcolor{grisFAO}{Informe generado el: \textbf{`r format(Sys.Date(), "%d de %B de %Y")`}}
\end{flushright}

# \textcolor{violetaFAO}{\LARGE Parámetros con los cuales se generó el informe}

```{r params-tabla, message=FALSE, warning=FALSE}
df_params <- data.frame(
  "Parámetro" = c("Temporalidad:", "Variable:", "Año:", "Producto:"),
  "Valor" = c(
    ifelse(is.na(params$temporalidad), "N/A", params$temporalidad),
    ifelse(is.na(params$variable), "N/A", params$variable),
    ifelse(is.na(params$anio), "N/A", params$anio),
    ifelse(is.na(params$producto), "N/A", params$producto)
  )
)

knitr::kable(df_params, col.names = NULL, format = "latex", booktabs = TRUE, align = 'l') %>%
  kable_styling(latex_options = c("hold_position"))
```

\vspace{0.5cm}

# \textcolor{violetaFAO}{\LARGE Correlación de precios mayoristas entre productos}

\fontsize{11}{13}\selectfont
El presente informe muestra las correlaciones entre los precios mayoristas de los principales productos agropecuarios registrados en la central de abastecimiento de Bogotá.  
Una correlación positiva cercana a **1** indica que los precios de ambos productos tienden a moverse en la misma dirección, mientras que una correlación negativa sugiere que los precios se mueven en sentidos opuestos.

---

# \textcolor{violetaFAO}{Visualización de la matriz de correlación}

```{r grafico, out.width='90%', fig.align='center'}
if (inherits(params$grafico, "plotly")) {
  tmp_png <- tempfile(fileext = ".png")
  tmp_html <- tempfile(fileext = ".html")
  htmlwidgets::saveWidget(as_widget(params$grafico), tmp_html, selfcontained = TRUE)
  webshot2::webshot(tmp_html, tmp_png, vwidth = 1200, vheight = 800)
  knitr::include_graphics(tmp_png)
} else if (is.character(params$grafico) && file.exists(params$grafico)) {
  knitr::include_graphics(params$grafico)
} else {
  cat("⚠️ No hay gráfico disponible para los parámetros seleccionados.")
}
```

\newpage

# \textcolor{violetaFAO}{Principales correlaciones}

```{r top5, results='asis'}
if (!is.null(df) && nrow(df) > 0) {
  suppressMessages({
    cor_df <- as.data.frame(as.table(df)) %>%
      filter(Var1 != Var2) %>%
      mutate(
        Var1 = as.character(Var1),
        Var2 = as.character(Var2),
        pair = paste(pmin(Var1, Var2), pmax(Var1, Var2), sep = "_")
      ) %>%
      distinct(pair, .keep_all = TRUE)
    
    top5 <- cor_df %>% arrange(desc(Freq)) %>% head(5)
    low5 <- cor_df %>% arrange(Freq) %>% head(5)
  })
  
  cat("\\begin{flushleft}\n")
  cat("\\textcolor{violetaFAO}{\\textbf{Top 5 correlaciones más altas:}}\\\\[6pt]\n")
  for (i in seq_len(nrow(top5))) {
    cat(paste0("\\textcolor{verdeFAO}{• ", top5$Var1[i], " – ", top5$Var2[i],
               ": }\\textbf{", sprintf('%.2f', top5$Freq[i]), "}\\\\\n"))
  }
  cat("\\vspace{0.4cm}\n")
  cat("\\textcolor{violetaFAO}{\\textbf{Top 5 correlaciones más bajas:}}\\\\[6pt]\n")
  for (i in seq_len(nrow(low5))) {
    cat(paste0("\\textcolor{rojoFAO}{• ", low5$Var1[i], " – ", low5$Var2[i],
               ": }\\textbf{", sprintf('%.2f', low5$Freq[i]), "}\\\\\n"))
  }
  cat("\\end{flushleft}\n")
} else {
  cat("No hay datos suficientes para calcular correlaciones destacadas.")
}
```

\newpage

# \textcolor{violetaFAO}{Matriz numérica de correlaciones}

```{r tabla, results='asis'}
if (!is.null(df) && nrow(df) > 0) {
  num_cols <- ncol(df)
  bloques <- split(seq_len(num_cols), ceiling(seq_along(seq_len(num_cols)) / 5))
  n_bloques <- length(bloques)
  
  for (b in seq_along(bloques)) {
    sub_df <- df[, bloques[[b]], drop = FALSE]
    sub_df <- round(sub_df, 2)
    
    kable(sub_df, format = "latex", booktabs = TRUE, align = "c",
          caption = paste("Matriz de correlaciones (bloque", b, "de", n_bloques, ")")) %>%
      kable_styling(latex_options = c("striped", "hold_position")) %>%
      row_spec(0, bold = TRUE, color = "white", background = "violetaFAO") %>%
      print()
    
    if (b < n_bloques) cat("\n\\newpage\n")
  }
} else {
  cat("No hay datos disponibles para generar la tabla.")
}
```

\newpage

# \textcolor{violetaFAO}{Notas metodológicas y fuente}

\fontsize{9}{11}\selectfont
- Las correlaciones se calculan mediante el coeficiente de Pearson, utilizando precios promedio mensuales.  
- Solo se consideran productos con información completa durante el año analizado.  
- Los resultados reflejan la estructura de co-movimientos de precios en el mercado mayorista.  
\vspace{0.4cm}

\textcolor{violetaFAO}{\textbf{Fuente:}} Sistema de Información de Precios y Abastecimiento del Sector Agropecuario (SIPSA) – DANE.  
Elaboración propia, FAO 2025.

\AddToShipoutPictureBG*{
  \put(0,20){\includegraphics[width=\paperwidth,height=3cm,keepaspectratio]{www/logo_2.png}}
}
