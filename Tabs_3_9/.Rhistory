"Chócolo mazorca",         "Hortalizas",                     100,
"Ciruela nacional",        "Frutas templadas",               110,
"Coco",                    "Frutas tropicales",              120,
"Curuba",                  "Frutas tropicales",              120,
"Durazno nacional",        "Frutas templadas",               110,
"Fresa",                   "Frutas templadas refrigeradas",  130,
"Fríjol verde",            "Legumbres frescas",              100,
"Frutas importadas otras", "Frutas importadas",              200,
"Frutas otras",            "Frutas mixtas",                  120,
"Gallina en pie",          "Carnes blancas",                 180,
"Garbanzo",                "Legumbres secas",                80,
"Granos Secos",            "Granos y cereales",              80,
"Guanábana",               "Frutas tropicales",              120,
"Guayaba común",           "Frutas tropicales",              120,
"Guayaba pera",            "Frutas tropicales",              120,
"Guayabas otras",          "Frutas tropicales",              120,
"Gulupa",                  "Frutas tropicales",              120,
"Habichuela",              "Hortalizas",                     100,
"Hortalizas de hoja",      "Hortalizas de hoja",             100,
"Huevo",                   "Carnes blancas y huevos",        160,
"Jengibre",                "Condimentos",                    90,
"Kiwi",                    "Frutas importadas",              200,
"Lácteos otros",           "Lácteos y derivados",            140,
"Lechugas otras",          "Hortalizas de hoja",             100,
"Limón común",             "Frutas cítricas",                120,
"Limón mandarino",         "Frutas cítricas",                120,
"Limón Tahití",            "Frutas cítricas",                120,
"Limones otros",           "Frutas cítricas",                120,
"Mandarina Arrayana",      "Frutas cítricas",                120,
"Mandarina común",         "Frutas cítricas",                120,
"Mandarina Oneco",         "Frutas cítricas",                120,
"Mandarinas otras",        "Frutas cítricas",                120,
"Mango común",             "Frutas tropicales",              120,
"Mango de azúcar",         "Frutas tropicales",              120,
"Mango Yulima",            "Frutas tropicales",              120,
"Mangos otros",            "Frutas tropicales",              120,
"Mariscos otros",          "Pescados y mariscos frescos",    190,
"Mojarra",                 "Pescados y mariscos frescos",    180,
"Naranja común",           "Frutas cítricas",                120,
"Naranja Valencia",        "Frutas cítricas",                120,
"Naranja Valencia y/o Sweet","Frutas cítricas",              120,
"Naranjas otras",          "Frutas cítricas",                120,
"Nicuro",                  "Pescados y mariscos frescos",    180,
"Papa Betina",             "Tubérculos",                     90,
"Papa capira",             "Tubérculos",                     90,
"Papa Morasurco",          "Tubérculos",                     90,
"Papa nevada",             "Tubérculos",                     90,
"Papa R-12",               "Tubérculos",                     90,
"Papa rubí",               "Tubérculos",                     90,
"Papa superior",           "Tubérculos",                     90,
"Papa suprema",            "Tubérculos",                     90,
"Papa única",              "Tubérculos",                     90,
"Papas negras otras",      "Tubérculos",                     90,
"Papaya Paulina",          "Frutas tropicales",              120,
"Papaya tainung",          "Frutas tropicales",              120,
"Papayas otras",           "Frutas tropicales",              120,
"Patilla baby",            "Frutas tropicales",              120,
"Pepino cohombro",         "Hortalizas",                     100,
"Pepino de rellenar",      "Hortalizas",                     100,
"Perejil",                 "Hortalizas de hoja",             100,
"Pescado seco",            "Pescados procesados",            150,
"Piñas otras",             "Frutas tropicales",              120,
"Pitahaya",                "Frutas tropicales",              120,
"Plátanos otros",          "Plátanos y derivados",           100,
"Pollo en pie",            "Carnes blancas",                 180,
"Remolacha",               "Hortalizas",                     100,
"Tangelo",                 "Frutas cítricas",                120,
"Tomate Riogrande",        "Hortalizas",                     100,
"Tomates otros",           "Hortalizas",                     100,
"Tubérculos otros",        "Tubérculos",                     90,
"Ulluco",                  "Tubérculos",                     90,
"Uva Isabela",             "Frutas templadas",               110,
"Verduras y hortalizas otras", "Hortalizas",                100,
"Zapote",                  "Frutas tropicales",              120
)
factores_transporte <- factores_transporte %>% mutate( factor_tCO2_tkm = factor_gCO2e_kgkm / 1000)
#### Pegando bases abastecimiento, distancia, emisiones
data <- left_join(data_huella_carbono, factores_transporte, by=c("producto"))
data_filtrada <- data[is.na(data$categoria), ]
table(data_filtrada$producto) ## chequeando que todos los productos tengan huella carbono
remove(data_filtrada, abastecimiento, data_huella_carbono, distancias_extranjeras, distancias_long)
data$suma_kg_ton <- data$suma_kg/1000
data <- data %>%
mutate(distancia = ifelse(is.na(distancia), 1, distancia))
data$c02 <- data$suma_kg_ton*data$distancia*data$factor_tCO2_tkm
data$grupo_alimento <- paste0(
toupper(substr(data$grupo_alimento, 1, 1)),
tolower(substr(data$grupo_alimento, 2, nchar(data$grupo_alimento)))
)
data$anio <- as.numeric(data$anio)
data$mes  <- as.numeric(data$mes)
data <- data %>%
group_by(anio, mes, grupo_alimento, producto) %>%
summarise(
categoria        = dplyr::first(categoria),
factor_tCO2_tkm  = dplyr::first(factor_tCO2_tkm),
distancia        = dplyr::first(distancia),
total_ton        = sum(suma_kg_ton, na.rm = TRUE),
c02_total        = sum(c02, na.rm = TRUE),
.groups = "drop"
)
data$c02_total <- ceiling(data$c02_total)
View(data)
data$c02_total <- ceiling(data$total_ton)
data$c02_total <- ceiling(data$distancia)
saveRDS(data, file.path(data_output_index, "datos_c02_3_9.rds"))
data <- readRDS("datos_c02_3_9.rds")
head(data)
data_pesos <- data %>%
group_by(grupo_alimento, anio, mes) %>%
mutate(
peso_c02_grupo = ifelse(
sum(c02_total, na.rm = TRUE) > 0,
(c02_total / sum(c02_total, na.rm = TRUE)) * 100,
0
)
) %>%
ungroup()
data <- readRDS("datos_c02_3_9.rds")
head(data)
data <- data %>%
group_by(grupo_alimento, anio, mes) %>%
mutate(
peso_c02_grupo = ifelse(
sum(c02_total, na.rm = TRUE) > 0,
(c02_total / sum(c02_total, na.rm = TRUE)) * 100,
0
)
) %>%
ungroup()
View(data)
data$peso_c02_grupo <- ceiling(data$peso_c02_grupo)
head(data)
######
# Author:       Luis Miguel García
#               Laura Quintero
#               Daniel Obando
# First Edited: 2025/08/24
# Last Editor:  2025/09/12
# R version:    4.3.2
######
###############################
##### Libraries ###############
###############################
rm(list=ls())
pacman::p_load(readr, lubridate, dplyr, ggplot2, zoo, readxl,
glue,  tidyverse, gridExtra, corrplot, plotly,
treemapify, arrow)
options(scipen = 999)
###############################
##### Setting directories #####
###############################
##########
data <- readRDS("datos_c02_3_9.rds")
head(data)
data <- data %>%
group_by(grupo_alimento, anio, mes) %>%
mutate(
peso_c02_grupo = ifelse(
sum(c02_total, na.rm = TRUE) > 0,
(c02_total / sum(c02_total, na.rm = TRUE)) * 100,
0
)
) %>%
ungroup()
data$peso_c02_grupo <- ceiling(data$peso_c02_grupo)
head(data)
#########
graficar_treemap_producto <- function(data, anio, mes) {
# --- Normalizar mes ---
meses <- c("Enero" = 1, "Febrero" = 2, "Marzo" = 3, "Abril" = 4,
"Mayo" = 5, "Junio" = 6, "Julio" = 7, "Agosto" = 8,
"Septiembre" = 9, "Octubre" = 10, "Noviembre" = 11, "Diciembre" = 12)
if (mes %in% names(meses)) {
mes_num   <- meses[mes]
mes_label <- mes
} else if (is.numeric(mes) || mes %in% sprintf("%02d", 1:12)) {
mes_num   <- as.numeric(mes)
mes_label <- names(meses)[mes_num]
} else stop("Mes inválido.")
# --- Filtrar datos del periodo ---
df <- data %>%
filter(anio == anio, mes == mes_num, !is.na(c02_total), c02_total > 0)
if (nrow(df) == 0) stop(glue::glue("No hay datos para {mes_label} {anio}"))
# --- Agregar por grupo ---
grp_sum <- df %>%
group_by(grupo_alimento) %>%
summarise(
emisiones_tonCO2 = sum(c02_total, na.rm = TRUE),
cantidad_ton     = sum(total_ton, na.rm = TRUE),
distancia_km     = weighted.mean(distancia, w = total_ton, na.rm = TRUE),
.groups = "drop"
)
total_emisiones <- sum(grp_sum$emisiones_tonCO2, na.rm = TRUE)
# --- Estructura jerárquica ---
labels  <- c("Total", grp_sum$grupo_alimento, df$producto)
parents <- c(NA, rep("Total", nrow(grp_sum)), df$grupo_alimento)
values  <- c(total_emisiones, grp_sum$emisiones_tonCO2, df$c02_total)
# --- Colores ---
purple_scale <- colorRamp(c("#f2f0f7", "#7a1fa2"))
blue_scale   <- colorRamp(c("#e0ecf8", "#084594"))
norm <- function(x) if (diff(range(x, na.rm = TRUE)) == 0) rep(0.5, length(x)) else
(x - min(x, na.rm = TRUE)) / (max(x, na.rm = TRUE) - min(x, na.rm = TRUE))
colors <- c(
"#E0E0E0",
rgb(blue_scale(norm(grp_sum$emisiones_tonCO2)) / 255),
rgb(purple_scale(norm(df$c02_total)) / 255)
)
# --- Hover texts ---
hover_root <- glue::glue(
"<b>Total CO₂</b><br>",
"Emisiones: {format(round(total_emisiones,1), big.mark='.', decimal.mark=',')} tCO₂"
)
hover_grupos <- purrr::pmap_chr(
list(grp_sum$grupo_alimento, grp_sum$emisiones_tonCO2,
grp_sum$cantidad_ton, grp_sum$distancia_km),
\(g, e, c, d) glue::glue(
"<b>{g}</b><br>",
"Emisiones totales: {format(round(e,1), big.mark='.', decimal.mark=',')} tCO₂<br>",
"Cantidad total: {format(round(c,0), big.mark='.', decimal.mark=',')} t<br>",
"Distancia media: {round(d,0)} km"
)
)
hover_prod <- purrr::pmap_chr(
list(df$producto, df$grupo_alimento, df$c02_total,
df$total_ton, df$distancia, df$peso_c02_grupo),
\(p, g, e, c, d, w) glue::glue(
"<b>{p}</b><br>",
"Grupo: {g}<br>",
"Emisiones: {format(round(e,1), big.mark='.', decimal.mark=',')} tCO₂<br>",
"Peso dentro del grupo: {w}%<br>",
"Cantidad: {format(round(c,0), big.mark='.', decimal.mark=',')} t<br>",
"Distancia: {round(d,0)} km"
)
)
hover_text <- c(hover_root, hover_grupos, hover_prod)
# --- Treemap ---
plotly::plot_ly(
type        = "treemap",
labels      = labels,
parents     = parents,
values      = values,
branchvalues= "remainder",
textinfo    = "label+value+percent parent",
hoverinfo   = "text",
text        = hover_text,
marker      = list(colors = colors, line = list(color = "#fafafa", width = 1))
) %>%
layout(
title = list(
text = paste0(
"Huella de carbono por producto – ", mes_label, " ", anio,
"<br><span style='font-size:11pt;color:#6A1B9A;'>Área = toneladas de CO₂</span>"
),
x = 0.5
),
margin = list(t = 80, l = 10, r = 10, b = 10)
)
}
####
graficar_treemap_producto(data, anio = 2017, mes = 1)
######
# Author:       Luis Miguel García
#               Laura Quintero
#               Daniel Obando
# First Edited: 2025/08/24
# Last Editor:  2025/09/12
# R version:    4.3.2
######
###############################
##### Libraries ###############
###############################
rm(list=ls())
pacman::p_load(readr, lubridate, dplyr, ggplot2, zoo, readxl,
glue,  tidyverse, gridExtra, corrplot, plotly,
treemapify, arrow)
options(scipen = 999)
###############################
##### Setting directories #####
###############################
##########
data <- readRDS("datos_c02_3_9.rds")
head(data)
data <- data %>%
group_by(grupo_alimento, anio, mes) %>%
mutate(
peso_c02_grupo = ifelse(
sum(c02_total, na.rm = TRUE) > 0,
(c02_total / sum(c02_total, na.rm = TRUE)) * 100,
0
)
) %>%
ungroup()
data$peso_c02_grupo <- ceiling(data$peso_c02_grupo)
head(data)
#########
graficar_treemap_producto <- function(data, anio, mes) {
# --- Normalizar mes ---
meses <- c("Enero" = 1, "Febrero" = 2, "Marzo" = 3, "Abril" = 4,
"Mayo" = 5, "Junio" = 6, "Julio" = 7, "Agosto" = 8,
"Septiembre" = 9, "Octubre" = 10, "Noviembre" = 11, "Diciembre" = 12)
if (mes %in% names(meses)) {
mes_num   <- meses[mes]
mes_label <- mes
} else if (is.numeric(mes) || mes %in% sprintf("%02d", 1:12)) {
mes_num   <- as.numeric(mes)
mes_label <- names(meses)[mes_num]
} else stop("Mes inválido.")
# --- Filtrar datos del periodo ---
df <- data %>%
filter(anio == anio, mes == mes_num, !is.na(c02_total), c02_total > 0)
if (nrow(df) == 0) stop(glue::glue("No hay datos para {mes_label} {anio}"))
# --- Agregar por grupo ---
grp_sum <- df %>%
group_by(grupo_alimento) %>%
summarise(
emisiones_tonCO2 = sum(c02_total, na.rm = TRUE),
cantidad_ton     = sum(total_ton, na.rm = TRUE),
distancia_km     = weighted.mean(distancia, w = total_ton, na.rm = TRUE),
.groups = "drop"
)
total_emisiones <- sum(grp_sum$emisiones_tonCO2, na.rm = TRUE)
# --- Estructura jerárquica ---
labels  <- c("Total", grp_sum$grupo_alimento, df$producto)
parents <- c(NA, rep("Total", nrow(grp_sum)), df$grupo_alimento)
values  <- c(total_emisiones, grp_sum$emisiones_tonCO2, df$c02_total)
# --- Colores ---
purple_scale <- colorRamp(c("#f2f0f7", "#7a1fa2"))
blue_scale   <- colorRamp(c("#e0ecf8", "#084594"))
norm <- function(x) if (diff(range(x, na.rm = TRUE)) == 0) rep(0.5, length(x)) else
(x - min(x, na.rm = TRUE)) / (max(x, na.rm = TRUE) - min(x, na.rm = TRUE))
colors <- c(
"#E0E0E0",
rgb(blue_scale(norm(grp_sum$emisiones_tonCO2)) / 255),
rgb(purple_scale(norm(df$c02_total)) / 255)
)
# --- Hover texts ---
hover_root <- glue::glue(
"<b>Total CO₂</b><br>",
"Emisiones: {format(round(total_emisiones,1), big.mark='.', decimal.mark=',')} tCO₂"
)
hover_grupos <- purrr::pmap_chr(
list(grp_sum$grupo_alimento, grp_sum$emisiones_tonCO2,
grp_sum$cantidad_ton, grp_sum$distancia_km),
\(g, e, c, d) glue::glue(
"<b>{g}</b><br>",
"Emisiones totales: {format(round(e,1), big.mark='.', decimal.mark=',')} tCO₂<br>",
"Cantidad total: {format(round(c,0), big.mark='.', decimal.mark=',')} t<br>",
"Distancia media: {round(d,0)} km"
)
)
hover_prod <- purrr::pmap_chr(
list(df$producto, df$grupo_alimento, df$c02_total,
df$total_ton, df$distancia, df$peso_c02_grupo),
\(p, g, e, c, d, w) glue::glue(
"<b>{p}</b><br>",
"Grupo: {g}<br>",
"Emisiones: {format(round(e,1), big.mark='.', decimal.mark=',')} tCO₂<br>",
"Peso dentro del grupo: {w}%<br>",
"Cantidad: {format(round(c,0), big.mark='.', decimal.mark=',')} t<br>",
"Distancia: {round(d,0)} km"
)
)
hover_text <- c(hover_root, hover_grupos, hover_prod)
plotly::plot_ly(
type        = "treemap",
labels      = labels,
parents     = parents,
values      = values,
branchvalues = "total",  # <---- aquí el cambio
textinfo    = "label+value+percent parent",
hoverinfo   = "text",
text        = hover_text,
marker      = list(colors = colors, line = list(color = "#fafafa", width = 1))
) %>%
layout(
title = list(
text = paste0(
"Huella de carbono por producto – ", mes_label, " ", anio,
"<br><span style='font-size:11pt;color:#6A1B9A;'>Área = toneladas de CO₂</span>"
),
x = 0.5
),
margin = list(t = 80, l = 10, r = 10, b = 10)
)
}
####
graficar_treemap_producto(data, anio = 2017, mes = 1)
shiny::runApp("C:/Users/Usuario/Dropbox/SIMAGRO/Tableros/Tabs_3_9")
######
# Author:       Luis Miguel García
#               Laura Quintero
#               Daniel Obando
# First Edited: 2025/08/24
# Last Editor:  2025/09/12
# R version:    4.3.2
######
###############################
##### Libraries ###############
###############################
rm(list=ls())
pacman::p_load(readr, lubridate, dplyr, ggplot2, zoo, readxl,
glue,  tidyverse, gridExtra, corrplot, plotly,
treemapify, arrow)
options(scipen = 999)
###############################
##### Setting directories #####
###############################
##########
data <- readRDS("datos_c02_3_9.rds")
head(data)
data <- data %>%
group_by(grupo_alimento, anio, mes) %>%
mutate(
peso_c02_grupo = ifelse(
sum(c02_total, na.rm = TRUE) > 0,
(c02_total / sum(c02_total, na.rm = TRUE)) * 100,
0
)
) %>%
ungroup()
data$peso_c02_grupo <- ceiling(data$peso_c02_grupo)
head(data)
#########
graficar_treemap_producto <- function(data, anio, mes) {
# --- Normalizar mes ---
meses <- c("Enero" = 1, "Febrero" = 2, "Marzo" = 3, "Abril" = 4,
"Mayo" = 5, "Junio" = 6, "Julio" = 7, "Agosto" = 8,
"Septiembre" = 9, "Octubre" = 10, "Noviembre" = 11, "Diciembre" = 12)
if (mes %in% names(meses)) {
mes_num   <- meses[mes]
mes_label <- mes
} else if (is.numeric(mes) || mes %in% sprintf("%02d", 1:12)) {
mes_num   <- as.numeric(mes)
mes_label <- names(meses)[mes_num]
} else stop("Mes inválido.")
# --- Filtrar datos del periodo ---
df <- data %>%
filter(anio == anio, mes == mes_num, !is.na(c02_total), c02_total > 0)
if (nrow(df) == 0) stop(glue::glue("No hay datos para {mes_label} {anio}"))
# --- Agregar por grupo ---
grp_sum <- df %>%
group_by(grupo_alimento) %>%
summarise(
emisiones_tonCO2 = sum(c02_total, na.rm = TRUE),
cantidad_ton     = sum(total_ton, na.rm = TRUE),
distancia_km     = weighted.mean(distancia, w = total_ton, na.rm = TRUE),
.groups = "drop"
)
total_emisiones <- sum(grp_sum$emisiones_tonCO2, na.rm = TRUE)
# --- Jerarquía ---
labels  <- c(grp_sum$grupo_alimento, df$producto)
parents <- c(rep("Total", nrow(grp_sum)), df$grupo_alimento)
values  <- c(grp_sum$emisiones_tonCO2, df$c02_total)
# --- Colores ---
purple_scale <- colorRamp(c("#f2f0f7", "#7a1fa2"))
blue_scale   <- colorRamp(c("#e0ecf8", "#084594"))
norm <- function(x) if (diff(range(x, na.rm = TRUE)) == 0) rep(0.5, length(x)) else
(x - min(x, na.rm = TRUE)) / (max(x, na.rm = TRUE) - min(x, na.rm = TRUE))
colors <- c(
rgb(blue_scale(norm(grp_sum$emisiones_tonCO2)) / 255),
rgb(purple_scale(norm(df$c02_total)) / 255)
)
# --- Hover texts ---
hover_grupos <- purrr::pmap_chr(
list(grp_sum$grupo_alimento, grp_sum$emisiones_tonCO2,
grp_sum$cantidad_ton, grp_sum$distancia_km),
\(g, e, c, d) glue::glue(
"<b>{g}</b><br>",
"Emisiones totales: {format(round(e,1), big.mark='.', decimal.mark=',')} tCO₂<br>",
"Cantidad total: {format(round(c,0), big.mark='.', decimal.mark=',')} t<br>",
"Distancia media: {round(d,0)} km"
)
)
hover_prod <- purrr::pmap_chr(
list(df$producto, df$grupo_alimento, df$c02_total,
df$total_ton, df$distancia, df$peso_c02_grupo),
\(p, g, e, c, d, w) glue::glue(
"<b>{p}</b><br>",
"Grupo: {g}<br>",
"Emisiones: {format(round(e,1), big.mark='.', decimal.mark=',')} tCO₂<br>",
"Peso dentro del grupo: {w}%<br>",
"Cantidad: {format(round(c,0), big.mark='.', decimal.mark=',')} t<br>",
"Distancia: {round(d,0)} km"
)
)
hover_text <- c(hover_grupos, hover_prod)
# --- Treemap ---
plotly::plot_ly(
type        = "treemap",
labels      = labels,
parents     = parents,
values      = values,
branchvalues= "remainder",   # <--- clave: calcula automáticamente proporciones reales
textinfo    = "label+value+percent parent",
hoverinfo   = "text",
text        = hover_text,
marker      = list(colors = colors, line = list(color = "#fafafa", width = 1))
) %>%
layout(
title = list(
text = paste0(
"Huella de carbono por producto – ", mes_label, " ", anio,
"<br><span style='font-size:11pt;color:#6A1B9A;'>Área = toneladas de CO₂</span>"
),
x = 0.5
),
margin = list(t = 80, l = 10, r = 10, b = 10)
)
}
####
graficar_treemap_producto(data, anio = 2017, mes = 1)
