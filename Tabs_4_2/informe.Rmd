---
title: "Mapa de rutas de abastecimiento por región - FAO 2025"
output:
  pdf_document:
    latex_engine: xelatex
    toc: false
params:
  datos: NA
  grafico: NA
  anio: NA
  mes: NA
  producto: NA
  logo_sup: NA
  logo_inf: NA
header-includes:
  - \usepackage[utf8]{inputenc}
  - \usepackage[T1]{fontenc}
  - \usepackage[spanish,es-tabla]{babel}
  - \usepackage{lmodern}
  - \usepackage{booktabs}
  - \usepackage[table]{xcolor}
  - \usepackage{colortbl}
  - \usepackage{float}
  - \usepackage{graphicx}
  - \usepackage{geometry}
  - \geometry{top=2.5cm,bottom=2.5cm,left=2.5cm,right=2.5cm}
  - \definecolor{violetaFAO}{RGB}{123,31,162}
  - \selectlanguage{spanish}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
library(dplyr)
library(knitr)
library(kableExtra)
library(htmlwidgets)
library(webshot2)
library(leaflet)
try(Sys.setlocale("LC_TIME", "es_ES.UTF-8"), silent = TRUE)
df <- params$datos
```

```{r logos, echo=FALSE, out.width='100%', fig.align='center'}
if (file.exists(params$logo_sup)) knitr::include_graphics(params$logo_sup)
```

---

# \textcolor{violetaFAO}{\LARGE Rutas de abastecimiento por región geográfica}

\textcolor{violetaFAO}{\large \textbf{Año: `r params$anio` — Mes: `r month.name[as.numeric(params$mes)]` — Producto: `r params$producto`}}  

Este informe presenta la distribución geográfica de las rutas de abastecimiento para el producto seleccionado, clasificadas según su dirección cardinal desde Bogotá.  
Cada color representa una **región geográfica**, y el grosor de las líneas indica la **proporción del flujo regional** sobre el total transportado.

---

# Visualización general

```{r grafico, fig.align='center', out.width='95%'}
if (inherits(params$grafico, "leaflet")) {
  tmp_html <- tempfile(fileext = ".html")
  tmp_png  <- tempfile(fileext = ".png")
  htmlwidgets::saveWidget(params$grafico, tmp_html, selfcontained = TRUE)
  webshot2::webshot(tmp_html, tmp_png, vwidth = 1600, vheight = 1000)
  knitr::include_graphics(tmp_png)
} else if (is.character(params$grafico) && file.exists(params$grafico)) {
  knitr::include_graphics(params$grafico)
} else {
  cat("No hay mapa disponible para los parámetros seleccionados.")
}
```

---

# Interpretación

- Los **colores** distinguen las rutas según su orientación geográfica.  
- El **grosor** representa la participación regional en el total de abastecimiento.  
- Las regiones con mayor densidad de líneas más gruesas concentran los principales flujos logísticos.  
- Este análisis permite identificar las áreas con **mayor relevancia logística** en el abastecimiento de Bogotá.

---

# Principales regiones del mes

```{r tabla_regiones, echo=FALSE}
if (!is.null(df) && nrow(df) > 0) {
  tabla_top <- df %>%
    group_by(region_geo) %>%
    summarise(
      `Importancia regional (%)` = round(sum(prop_region_producto, na.rm = TRUE) * 100, 2),
      `Número de rutas` = n()
    ) %>%
    arrange(desc(`Importancia regional (%)`))

  kable(tabla_top, format = "latex", booktabs = TRUE, align = "lcc",
        caption = "Distribución de importancia relativa por región geográfica") %>%
    kable_styling(latex_options = c("striped", "hold_position"))
} else {
  cat("No hay datos disponibles para generar la tabla de regiones.")
}
```

---

# Top 10 rutas más relevantes

```{r tabla_top_rutas, echo=FALSE}
if (!is.null(df) && nrow(df) > 0) {
  tabla_rutas <- df %>%
    arrange(desc(importancia_ruta)) %>%
    select(region_geo, mpio_origen, depto_origen, distancia, importancia_ruta) %>%
    head(10) %>%
    mutate(
      importancia_ruta = round(importancia_ruta * 100, 2),
      distancia = round(distancia, 1)
    ) %>%
    rename(
      "Región" = region_geo,
      "Municipio origen" = mpio_origen,
      "Departamento" = depto_origen,
      "Distancia (km)" = distancia,
      "Importancia (%)" = importancia_ruta
    )

  kable(tabla_rutas, format = "latex", booktabs = TRUE, align = "lcccc",
        caption = "Top 10 rutas más importantes en el abastecimiento regional") %>%
    kable_styling(latex_options = c("striped", "hold_position"))
} else {
  cat("No hay datos disponibles para generar la tabla de rutas.")
}
```

---

```{r logo_inf, echo=FALSE, out.width='100%', fig.align='center'}
if (file.exists(params$logo_inf)) knitr::include_graphics(params$logo_inf)
```
